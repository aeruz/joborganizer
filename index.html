<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AnimTrack - Offline 3D Manager</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX (Pinned Version to fix esmodules error) -->
    <script src="https://unpkg.com/@babel/standalone@7.23.8/babel.min.js"></script>

    <!-- Import Map for Modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #111827; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #4B5563; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        body { background-color: #030712; color: #f3f4f6; overflow: hidden; overscroll-behavior: none; }
        
        /* Tooltip Fade In */
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Rich Text Editor Styles */
        .editor-content ul { list-style-type: disc; margin-left: 1.25rem; margin-bottom: 0.5rem; }
        .editor-content ol { list-style-type: decimal; margin-left: 1.25rem; margin-bottom: 0.5rem; }
        .editor-content li { margin-bottom: 0.25rem; }
        .editor-content b, .editor-content strong { font-weight: bold; }
        .editor-content i, .editor-content em { font-style: italic; }
        .editor-content u { text-decoration: underline; }
        .editor-content p { margin-bottom: 0.5rem; }
        
        /* Dynamic Font Sizing map for the editor */
        .editor-content font[size="1"] { font-size: 10px; }
        .editor-content font[size="2"] { font-size: 12px; }
        .editor-content font[size="3"] { font-size: 14px; } /* Default editor size */
        .editor-content font[size="4"] { font-size: 16px; }
        .editor-content font[size="5"] { font-size: 20px; }
        .editor-content font[size="6"] { font-size: 24px; }
        .editor-content font[size="7"] { font-size: 32px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plus, DollarSign, Clock, CheckCircle, Film, Box, Calendar, Edit2, 
            Trash2, X, Save, TrendingUp, CreditCard, MonitorPlay, Briefcase, 
            ChevronLeft, ChevronRight, AlertCircle, Filter, AlignLeft, Settings, 
            Layers, ArrowRight, ShieldCheck, AlertTriangle, User, MoreHorizontal, 
            Download, Upload, FileJson, Sliders, WifiOff, LayoutGrid, CalendarDays,
            BarChart2, PenTool, Sparkles, Image as ImageIcon, Target, Star, Folder, 
            FolderOpen, RotateCcw, Bold, Italic, Underline, List, ListOrdered,
            Eye, EyeOff, Type, Highlighter, Eraser, Minus, Gift, Heart, Flag, Sun, 
            Moon, Cloud, Snowflake, Music, Flame, Zap, Anchor, Bell, Camera, Coffee, 
            Smile, ThumbsUp, Umbrella, Plane, Car, Leaf, Crown, Trophy, Shield, Gem
        } from 'lucide-react';

        // --- Holiday Icon Options ---
        const ICON_OPTIONS = {
            Star, Gift, Heart, Flag, Sun, Moon, Cloud, Snowflake, Music, Flame, 
            Zap, Anchor, Bell, Camera, Coffee, Smile, ThumbsUp, Umbrella, Plane, 
            Car, Leaf, Crown, Trophy, Shield, Gem
        };

        // --- Local Storage Helper ---
        const STORAGE_KEY = 'animtrack_db_v12'; // Bumped version for Leaves
        
        const loadData = () => {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (parsed.clients) {
                        parsed.clients = parsed.clients.map(c => ({
                            ...c,
                            mode: c.mode || 'per_shot',
                            defaultRate: c.defaultRate || 0,
                            payDay: c.payDay || 25
                        }));
                    }
                    if (!parsed.holidays) parsed.holidays = [];
                    if (!parsed.leaves) parsed.leaves = []; // Ensure leaves array exists
                    if (parsed.totalLeaves === undefined) parsed.totalLeaves = 24; // Ensure totalLeaves exists
                    return parsed;
                }
            } catch (e) {
                console.error("Data load error", e);
            }
            return {
                projects: [],
                clients: [
                    { name: 'Example Studio', mode: 'per_shot', defaultRate: 150, projects: ['Season 1'] },
                    { name: 'Retainer Client', mode: 'monthly', defaultRate: 2500, payDay: 25, projects: ['Commercials'] }
                ],
                holidays: [],
                leaves: [],
                totalLeaves: 24
            };
        };

        const saveData = (data) => {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error("Save error", e);
            }
        };

        // --- Date Helpers (Strict Local Time) ---
        const parseLocalDate = (dateStr) => {
            if (!dateStr) return null;
            if (dateStr instanceof Date) return dateStr; 
            if (dateStr.includes('T')) return new Date(dateStr); 
            
            const [y, m, d] = dateStr.split('-').map(Number);
            return new Date(y, m - 1, d);
        };

        const getLocalDateString = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const getDayDiff = (d1, d2) => {
            const date1 = parseLocalDate(d1);
            const date2 = parseLocalDate(d2);
            if (!date1 || !date2) return 0;
            date1.setHours(0,0,0,0);
            date2.setHours(0,0,0,0);
            const diffTime = date2.getTime() - date1.getTime();
            return Math.round(diffTime / (1000 * 60 * 60 * 24)); 
        };

        // --- Helper for calculating item rate ---
        const getProjectRate = (project, clients) => {
            const client = clients.find(c => c.name === project.client);
            const mode = client?.mode || 'per_shot';
            if (mode === 'monthly') {
                 if (project.payType === 'monthly_salary') return parseFloat(project.fixedPrice || client?.defaultRate || 0);
                 return 0;
            } else if (mode === 'per_project') {
                return parseFloat(project.fixedPrice || 0);
            } else {
                return parseFloat(project.shotRate || 0) * parseInt(project.shotCount || 0);
            }
        };

        // --- Helper to strip HTML for descriptions ---
        const stripHtml = (html) => {
            if (!html) return '';
            const doc = new DOMParser().parseFromString(html, 'text/html');
            return doc.body.textContent || "";
        };

        // --- Rich Text Editor Component ---
        const RichTextEditor = ({ value, onChange }) => {
            const editorRef = useRef(null);

            // Sync initial value or external updates
            useEffect(() => {
                if (editorRef.current && value !== editorRef.current.innerHTML) {
                    // Prevent cursor jumping if focused
                    if (document.activeElement !== editorRef.current) {
                        editorRef.current.innerHTML = value || '';
                    }
                }
            }, [value]);

            const handleInput = () => {
                const html = editorRef.current.innerHTML;
                onChange(html);
            };

            const selectAllIfNone = () => {
                const selection = window.getSelection();
                const isOutside = !editorRef.current || !editorRef.current.contains(selection.anchorNode);
                if ((selection.isCollapsed || isOutside) && editorRef.current) {
                    const range = document.createRange();
                    range.selectNodeContents(editorRef.current);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            };

            const execCmd = (cmd, e) => {
                e.preventDefault(); // Prevent focus loss
                document.execCommand(cmd, false, null);
                handleInput();
            };

            const execColor = (cmd, val) => {
                document.execCommand('styleWithCSS', false, true);
                document.execCommand(cmd, false, val);
                handleInput();
            };

            const changeFontSize = (e, delta) => {
                e.preventDefault();
                selectAllIfNone();

                let current = document.queryCommandValue('fontSize');
                let currentSize = parseInt(current);
                
                // If it's a px value from pasted text or invalid, snap it to the default scale
                if (isNaN(currentSize) || currentSize < 1 || currentSize > 7 || String(current).includes('px')) {
                    currentSize = 3;
                }
                
                let newSize = currentSize + delta;
                if (newSize < 1) newSize = 1;
                if (newSize > 7) newSize = 7;
                
                document.execCommand('styleWithCSS', false, false);
                document.execCommand('fontSize', false, newSize);
                handleInput();
            };

            const resetColors = (e) => {
                e.preventDefault();
                selectAllIfNone();

                // 1. Reset Colors to default
                document.execCommand('styleWithCSS', false, true);
                document.execCommand('foreColor', false, '#d1d5db'); 
                document.execCommand('hiliteColor', false, 'transparent'); 
                
                // 2. Reset Font Size to default (Size 3 aligns with our text-sm)
                document.execCommand('styleWithCSS', false, false);
                document.execCommand('fontSize', false, '3'); 

                handleInput();
            };

            return (
                <div className="bg-gray-950 border border-gray-800 rounded-xl overflow-hidden flex flex-col min-h-[500px]">
                    <div className="flex flex-wrap items-center gap-1 p-2 bg-gray-900 border-b border-gray-800 sticky top-0 z-10">
                        <button onMouseDown={(e) => execCmd('bold', e)} className="p-1.5 rounded hover:bg-gray-800 text-gray-400 hover:text-white transition-colors" title="Bold"><Bold size={14} /></button>
                        <button onMouseDown={(e) => execCmd('italic', e)} className="p-1.5 rounded hover:bg-gray-800 text-gray-400 hover:text-white transition-colors" title="Italic"><Italic size={14} /></button>
                        <button onMouseDown={(e) => execCmd('underline', e)} className="p-1.5 rounded hover:bg-gray-800 text-gray-400 hover:text-white transition-colors" title="Underline"><Underline size={14} /></button>
                        
                        <div className="w-px h-4 bg-gray-700 mx-1" />
                        
                        <button onMouseDown={(e) => execCmd('insertUnorderedList', e)} className="p-1.5 rounded hover:bg-gray-800 text-gray-400 hover:text-white transition-colors" title="Bullet List"><List size={14} /></button>
                        <button onMouseDown={(e) => execCmd('insertOrderedList', e)} className="p-1.5 rounded hover:bg-gray-800 text-gray-400 hover:text-white transition-colors" title="Numbered List"><ListOrdered size={14} /></button>
                        
                        <div className="w-px h-4 bg-gray-700 mx-1" />
                        
                        <div className="relative p-1.5 rounded hover:bg-gray-800 text-gray-400 hover:text-white transition-colors cursor-pointer" title="Text Color">
                            <Type size={14} />
                            <input type="color" className="absolute inset-0 opacity-0 w-full h-full cursor-pointer" onChange={(e) => execColor('foreColor', e.target.value)} />
                        </div>
                        
                        <div className="relative p-1.5 rounded hover:bg-gray-800 text-gray-400 hover:text-white transition-colors cursor-pointer" title="Highlight Color">
                            <Highlighter size={14} />
                            <input type="color" className="absolute inset-0 opacity-0 w-full h-full cursor-pointer" onChange={(e) => execColor('hiliteColor', e.target.value)} />
                        </div>

                        <div className="w-px h-4 bg-gray-700 mx-1" />
                        
                        <button onMouseDown={(e) => changeFontSize(e, -1)} className="p-1.5 rounded hover:bg-gray-800 text-gray-400 hover:text-white transition-colors" title="Decrease Font Size"><Minus size={14} /></button>
                        <button onMouseDown={(e) => changeFontSize(e, 1)} className="p-1.5 rounded hover:bg-gray-800 text-gray-400 hover:text-white transition-colors" title="Increase Font Size"><Plus size={14} /></button>

                        <div className="w-px h-4 bg-gray-700 mx-1" />

                        <button onMouseDown={resetColors} className="p-1.5 rounded hover:bg-gray-800 text-gray-400 hover:text-white transition-colors" title="Reset Formatting (Colors & Size)">
                            <Eraser size={14} />
                        </button>
                    </div>
                    <div
                        ref={editorRef}
                        className="editor-content p-4 outline-none text-gray-300 text-sm font-sans flex-1"
                        contentEditable
                        onInput={handleInput}
                        suppressContentEditableWarning={true}
                    />
                </div>
            );
        };

        // --- Components ---

        const StatCard = ({ title, value, icon: Icon, colorClass, subtext, onClick }) => (
            <div onClick={onClick} className={`bg-gray-800 border border-gray-700 p-3 sm:p-4 rounded-xl flex items-center space-x-3 shadow-lg hover:border-gray-600 transition-colors relative overflow-hidden group ${onClick ? 'cursor-pointer hover:bg-gray-700' : ''}`}>
                <div className={`p-2 rounded-lg ${colorClass} bg-opacity-20`}>
                <Icon className={`w-4 h-4 sm:w-5 sm:h-5 ${colorClass.replace('bg-', 'text-')}`} />
                </div>
                <div className="z-10 min-w-0">
                <p className="text-gray-400 text-[10px] sm:text-xs font-medium truncate">{title}</p>
                <h3 className="text-lg sm:text-xl font-bold text-white truncate">{value}</h3>
                {subtext && <p className="text-[9px] sm:text-[10px] text-gray-500 mt-0.5 truncate">{subtext}</p>}
                </div>
                <Icon className={`absolute -right-4 -bottom-4 w-16 h-16 sm:w-20 sm:h-20 opacity-5 ${colorClass.replace('bg-', 'text-')} transform -rotate-12 group-hover:scale-110 transition-transform`} />
            </div>
        );

        const CalendarView = ({ projects, currentDate, onEdit, holidays }) => {
            const [dayProgress, setDayProgress] = useState(0);
            const [activeHoliday, setActiveHoliday] = useState(null); 

            useEffect(() => {
                const updateDayProgress = () => {
                    const now = new Date();
                    const totalMinutes = 24 * 60;
                    const passedMinutes = now.getHours() * 60 + now.getMinutes();
                    setDayProgress((passedMinutes / totalMinutes) * 100);
                };
                updateDayProgress();
                const interval = setInterval(updateDayProgress, 60000); 
                return () => clearInterval(interval);
            }, []);

            // Calendar Rendering Logic
            const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const startDate = new Date(startOfMonth);
            startDate.setDate(startDate.getDate() - startDate.getDay());
            
            const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const endDate = new Date(endOfMonth);
            if (endDate.getDay() !== 6) endDate.setDate(endDate.getDate() + (6 - endDate.getDay()));

            const weeks = [];
            let currentWeek = [];
            let dayIter = new Date(startDate);
            while (dayIter <= endDate) {
                currentWeek.push(new Date(dayIter));
                if (currentWeek.length === 7) { weeks.push(currentWeek); currentWeek = []; }
                dayIter.setDate(dayIter.getDate() + 1);
            }

            const getStatusColor = (item) => {
                if (item.isWorkingOn) return 'bg-blue-600 border-blue-400 text-white shadow-lg z-20 ring-1 ring-blue-300';
                switch(item.status) {
                    case 'paid': return 'bg-emerald-600/80 border-emerald-500 text-white';
                    case 'completed': return 'bg-yellow-600/80 border-yellow-500 text-white';
                    default: return 'bg-gray-700 border-gray-600 text-gray-200';
                }
            };

            return (
                <div className="bg-gray-900 border border-gray-800 rounded-xl shadow-xl overflow-hidden flex flex-col h-full">
                    <div className="flex-1 overflow-auto custom-scrollbar bg-gray-900">
                        <div className="min-w-[320px]">
                            <div className="grid grid-cols-7 border-b border-gray-800 bg-gray-950/50 sticky top-0 z-20">
                                {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (
                                    <div key={d} className="text-gray-500 text-[10px] uppercase font-bold text-center py-2">{d}</div>
                                ))}
                            </div>
                            
                            {weeks.map((week, wIdx) => {
                                // Find items in this week
                                let weekItems = projects.filter(p => {
                                   const start = parseLocalDate(p.startDate || p.createdAt) || new Date();
                                   const end = parseLocalDate(p.deadline) || new Date();
                                   const wStart = week[0];
                                   const wEnd = week[6];
                                   start.setHours(0,0,0,0);
                                   end.setHours(23,59,59,999);
                                   wStart.setHours(0,0,0,0);
                                   wEnd.setHours(23,59,59,999);
                                   return start <= wEnd && end >= wStart;
                                });

                                // Sort by start date to look nicer when stacked
                                weekItems.sort((a, b) => {
                                    const sa = parseLocalDate(a.startDate || a.createdAt);
                                    const sb = parseLocalDate(b.startDate || b.createdAt);
                                    return sa - sb;
                                });

                                // Dynamic Height Calculation
                                const itemHeight = 24; // 20px bar + 4px gap
                                const headerGap = 32; // Space for date numbers
                                const minHeight = 120;
                                const rowHeight = Math.max(minHeight, headerGap + (weekItems.length * itemHeight) + 10);

                                return (
                                    <div key={wIdx} className="relative border-b border-gray-800" style={{ height: `${rowHeight}px` }}>
                                            <div className="grid grid-cols-7 absolute inset-0 z-0">
                                                {week.map((day, dIdx) => {
                                                    const isToday = day.toDateString() === new Date().toDateString();
                                                    const isPast = day < new Date(new Date().setHours(0,0,0,0));
                                                    const isWeekend = dIdx === 0 || dIdx === 6;
                                                    
                                                    // Find holiday for this day/month
                                                    const currentMonth = day.getMonth() + 1;
                                                    const currentDay = day.getDate();
                                                    const holiday = holidays.find(h => h.month === currentMonth && h.day === currentDay);
                                                    
                                                    const IconComp = holiday && ICON_OPTIONS[holiday.iconName] ? ICON_OPTIONS[holiday.iconName] : null;

                                                    // Determine Background Class for cell
                                                    let bgClass = '';
                                                    if (isToday) bgClass = 'bg-gray-900';
                                                    else if (isWeekend) bgClass = isPast ? 'bg-gray-950' : 'bg-gray-800/30';
                                                    else if (isPast) bgClass = 'bg-gray-950/50';

                                                    return (
                                                        <div key={dIdx} className={`relative border-r border-gray-800/50 p-1 h-full cursor-pointer transition-colors ${bgClass} hover:bg-gray-800`}
                                                              onClick={()=>{
                                                                  if (holiday) {
                                                                      setActiveHoliday(activeHoliday?.id === holiday.id ? null : {id: holiday.id, date: day.toISOString(), ...holiday});
                                                                  } else {
                                                                      setActiveHoliday(null);
                                                                  }
                                                              }}>
                                                            {isToday && <div className="absolute inset-y-0 left-0 bg-blue-500/10 border-r border-blue-500/30 transition-all duration-1000" style={{width:`${dayProgress}%`}}/>}
                                                            
                                                            {/* Holiday Faint Background */}
                                                            {holiday && <div className="absolute inset-0 z-0 pointer-events-none" style={{backgroundColor: holiday.color, opacity: 0.15}}></div>}

                                                            {/* Holiday Icon */}
                                                            {holiday && IconComp && <IconComp size={22} className="absolute top-1 right-1 opacity-50 z-0" style={{color: holiday.color}} />}
                                                            
                                                            <span className={`relative z-10 text-xs font-bold ${isToday?'text-blue-400 text-lg':isPast?'text-gray-600':'text-gray-400'}`}>{day.getDate()}</span>
                                                            
                                                            {/* Holiday Popover */}
                                                            {holiday && activeHoliday?.id === holiday.id && activeHoliday?.date === day.toISOString() && (
                                                                <div className="absolute top-8 left-1/2 -translate-x-1/2 z-50 bg-gray-800 border p-3 rounded-lg shadow-2xl fade-in min-w-[160px] max-w-[200px]" style={{borderColor: holiday.color}}>
                                                                    <div className="font-bold text-white text-sm mb-1 flex items-center gap-1.5" style={{color: holiday.color}}>
                                                                        {IconComp && <IconComp size={14}/>} {holiday.name}
                                                                    </div>
                                                                    {holiday.description && <div className="text-[10px] text-gray-300 whitespace-pre-wrap">{holiday.description}</div>}
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                            <div className="relative z-10 w-full h-full pointer-events-none">
                                                {weekItems.map((item, idx) => {
                                                     const start = parseLocalDate(item.startDate || item.createdAt);
                                                     const end = parseLocalDate(item.deadline) || start;
                                                     const wStart = week[0];
                                                     
                                                     const diffStart = getDayDiff(wStart, start);
                                                     const diffEnd = getDayDiff(wStart, end);
                                                     const colStart = Math.max(0, diffStart);
                                                     const colEnd = Math.min(6, diffEnd);
                                                     
                                                     if (colStart > 6 || colEnd < 0) return null;
                                                     
                                                     const span = (colEnd - colStart) + 1;
                                                     
                                                     return (
                                                         <div key={item.id} 
                                                              className="absolute px-1 z-10 pointer-events-auto transition-all hover:z-20 hover:scale-[1.02]"
                                                              style={{
                                                                  left: `${(colStart / 7) * 100}%`,
                                                                  width: `${(span / 7) * 100}%`,
                                                                  top: `${headerGap + (idx * 24)}px`, // Stacking Down
                                                                  height: '20px'
                                                              }}
                                                         >
                                                             <button onClick={(e)=>{e.stopPropagation(); onEdit(item)}} className={`w-full text-left text-[9px] px-1.5 py-0.5 rounded truncate border-l-2 shadow-sm ${getStatusColor(item)}`}>
                                                                  {item.name}
                                                             </button>
                                                         </div>
                                                     )
                                                })}
                                            </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const LeaveTrackerView = ({ leaves, totalLeaves, onAddLeave, onDeleteLeave, onUpdateTotalLeaves }) => {
            const [isFiling, setIsFiling] = useState(false);
            const [form, setForm] = useState({ startDate: '', endDate: '', reason: '' });
            const [isEditingTotal, setIsEditingTotal] = useState(false);
            const [editTotalVal, setEditTotalVal] = useState(totalLeaves);

            // Cycle calc (July 1st to June 30th)
            const now = new Date();
            const currentYear = now.getFullYear();
            const cycleStartYear = now.getMonth() >= 6 ? currentYear : currentYear - 1;
            const cycleStart = new Date(cycleStartYear, 6, 1);
            const cycleEnd = new Date(cycleStartYear + 1, 5, 30);

            // Calculate accrued leaves based on 2 per month from July to the current month
            const currentMonthIndex = now.getMonth();
            const monthsPassed = (now.getFullYear() - cycleStartYear) * 12 + currentMonthIndex - 6 + 1;
            const missedLeaves = 24 - (totalLeaves || 24);
            const accruedLeaves = Math.max(0, Math.min(totalLeaves, (monthsPassed * 2) - missedLeaves));

            // Filter leaves for this cycle
            const cycleLeaves = leaves.filter(l => {
                const ld = parseLocalDate(l.startDate);
                return ld >= cycleStart && ld <= cycleEnd;
            }).sort((a,b) => parseLocalDate(b.startDate) - parseLocalDate(a.startDate));

            const usedLeaves = cycleLeaves.reduce((sum, l) => sum + (parseFloat(l.days) || 0), 0);
            const remainingLeaves = accruedLeaves - usedLeaves;

            const calcWeekdays = (start, end) => {
                let count = 0;
                let cur = new Date(start);
                while (cur <= end) {
                    const day = cur.getDay();
                    if (day !== 0 && day !== 6) count++; // skip weekends
                    cur.setDate(cur.getDate() + 1);
                }
                return count;
            }

            const handleSubmit = (e) => {
                e.preventDefault();
                const s = parseLocalDate(form.startDate);
                const eDate = form.endDate ? parseLocalDate(form.endDate) : s;
                
                if(!s || !eDate || s > eDate) return alert('Invalid dates selected.');
                
                const days = calcWeekdays(s, eDate);
                if (days <= 0) return alert('Selected range contains no working days (Weekends only).');

                onAddLeave({
                    id: crypto.randomUUID(),
                    startDate: form.startDate,
                    endDate: form.endDate || form.startDate,
                    days,
                    reason: form.reason,
                    createdAt: new Date().toISOString()
                });
                
                setIsFiling(false);
                setForm({ startDate: '', endDate: '', reason: '' });
            };

            return (
                <div className="flex flex-col h-full bg-gray-900 border border-gray-800 rounded-xl shadow-xl overflow-hidden p-6 custom-scrollbar overflow-y-auto">
                    <div className="flex justify-between items-start sm:items-center mb-6 flex-col sm:flex-row gap-4">
                        <div>
                            <h2 className="text-xl font-bold text-white flex items-center"><Umbrella className="mr-2 text-blue-400" size={24}/> Leave Tracker</h2>
                            <p className="text-sm text-gray-400 mt-1">Current Cycle: July {cycleStartYear} - June {cycleStartYear + 1}</p>
                        </div>
                        <button onClick={() => setIsFiling(true)} className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg flex items-center transition">
                            <Plus size={16} className="mr-1"/> File Leave
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        {isEditingTotal ? (
                            <div className="bg-gray-800 border border-blue-500 p-3 sm:p-4 rounded-xl flex flex-col justify-center space-y-2 shadow-lg h-full">
                                <label className="text-[10px] sm:text-xs text-gray-400 font-bold uppercase tracking-wide">Edit Total Leaves</label>
                                <div className="flex gap-2">
                                    <input type="number" step="0.5" className="w-full bg-gray-900 border border-gray-700 rounded p-1.5 text-white font-bold" value={editTotalVal} onChange={e=>setEditTotalVal(parseFloat(e.target.value) || 0)} />
                                    <button onClick={() => { onUpdateTotalLeaves(editTotalVal); setIsEditingTotal(false); }} className="bg-blue-600 hover:bg-blue-500 text-white px-3 rounded flex items-center justify-center transition"><CheckCircle size={14}/></button>
                                    <button onClick={() => setIsEditingTotal(false)} className="bg-gray-700 hover:bg-gray-600 text-white px-3 rounded flex items-center justify-center transition"><X size={14}/></button>
                                </div>
                            </div>
                        ) : (
                            <div className="relative group h-full">
                                <StatCard 
                                    title="Accrued Leaves" 
                                    value={accruedLeaves} 
                                    icon={Umbrella} 
                                    colorClass="bg-blue-500 text-blue-500" 
                                    subtext={`Max Yearly: ${totalLeaves}`} 
                                />
                                <button onClick={() => {setEditTotalVal(totalLeaves); setIsEditingTotal(true);}} className="absolute top-3 right-3 p-1.5 bg-gray-900/80 hover:bg-gray-700 text-gray-400 hover:text-white rounded-lg opacity-0 group-hover:opacity-100 transition shadow-lg border border-gray-600" title="Edit Max Yearly Leaves">
                                    <Edit2 size={14}/>
                                </button>
                            </div>
                        )}
                        <StatCard title="Used Leaves" value={usedLeaves} icon={TrendingUp} colorClass="bg-red-500 text-red-500" />
                        <StatCard title="Remaining" value={remainingLeaves} icon={CheckCircle} colorClass="bg-emerald-500 text-emerald-500" />
                    </div>

                    {isFiling && (
                        <div className="bg-gray-800 p-5 rounded-xl border border-gray-700 mb-8 relative fade-in shadow-xl">
                            <button onClick={()=>setIsFiling(false)} className="absolute top-4 right-4 text-gray-400 hover:text-white"><X size={18}/></button>
                            <h3 className="font-bold text-white mb-4 text-lg">File a New Leave</h3>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-xs text-gray-400 font-bold uppercase tracking-wide">Start Date</label>
                                        <input required type="date" className="w-full bg-gray-900 border border-gray-700 rounded p-2.5 mt-1 text-white" value={form.startDate} onChange={e=>setForm({...form, startDate:e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-400 font-bold uppercase tracking-wide">End Date <span className="text-gray-600 normal-case font-normal">(Optional)</span></label>
                                        <input type="date" className="w-full bg-gray-900 border border-gray-700 rounded p-2.5 mt-1 text-white" value={form.endDate} onChange={e=>setForm({...form, endDate:e.target.value})} />
                                    </div>
                                </div>
                                <div>
                                    <label className="text-xs text-gray-400 font-bold uppercase tracking-wide">Reason</label>
                                    <input required type="text" placeholder="e.g. Vacation, Sick Leave..." className="w-full bg-gray-900 border border-gray-700 rounded p-2.5 mt-1 text-white" value={form.reason} onChange={e=>setForm({...form, reason:e.target.value})} />
                                </div>
                                <div className="flex justify-end pt-3">
                                    <button type="submit" className="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-2.5 rounded-lg font-bold text-sm transition">Submit Leave</button>
                                </div>
                            </form>
                        </div>
                    )}

                    <div>
                        <h3 className="text-white font-bold mb-4 flex items-center border-b border-gray-800 pb-2"><CalendarDays className="mr-2 text-gray-400" size={18} /> Leave History <span className="ml-2 text-xs font-normal text-gray-500">(This Cycle)</span></h3>
                        <div className="space-y-3">
                            {cycleLeaves.map(l => (
                                <div key={l.id} className="bg-gray-800 p-4 rounded-xl border border-gray-700 flex justify-between items-center group transition hover:border-gray-600">
                                    <div>
                                        <div className="font-bold text-white flex items-center gap-2">
                                            <Calendar size={14} className="text-blue-400" />
                                            {parseLocalDate(l.startDate).toLocaleDateString()}
                                            {l.startDate !== l.endDate && ` - ${parseLocalDate(l.endDate).toLocaleDateString()}`}
                                        </div>
                                        <div className="text-sm text-gray-400 mt-1 pl-6 border-l-2 border-gray-700 ml-1">{l.reason}</div>
                                    </div>
                                    <div className="flex items-center gap-4">
                                        <span className="bg-gray-900 px-3 py-1 rounded text-sm text-emerald-400 font-bold border border-gray-700 shadow-inner">{l.days} Day{l.days > 1 ? 's' : ''}</span>
                                        <button onClick={()=>onDeleteLeave(l.id)} className="text-red-400 hover:text-red-300 opacity-0 group-hover:opacity-100 transition-opacity p-2 hover:bg-gray-700 rounded" title="Delete Leave"><Trash2 size={16}/></button>
                                    </div>
                                </div>
                            ))}
                            {cycleLeaves.length === 0 && <div className="text-center py-12 text-gray-500 italic border-2 border-dashed border-gray-800 rounded-xl bg-gray-900/50">No leaves filed for this cycle yet.</div>}
                        </div>
                    </div>
                </div>
            );
        };

        const HolidayManager = ({ isOpen, onClose, holidays, onUpdateHolidays }) => {
            const [localHolidays, setLocalHolidays] = useState(holidays || []);
            const [editIdx, setEditIdx] = useState(-1);
            const [form, setForm] = useState({ name: '', description: '', month: 1, day: 1, color: '#eab308', iconName: 'Star' });

            useEffect(() => { setLocalHolidays(holidays || []); }, [holidays, isOpen]);
            if (!isOpen) return null;

            const saveHoliday = () => {
                if(!form.name) return;
                const newHolidays = [...localHolidays];
                const holidayToSave = { ...form, month: parseInt(form.month), day: parseInt(form.day), id: editIdx > -1 ? localHolidays[editIdx].id : crypto.randomUUID() };
                
                if(editIdx > -1) newHolidays[editIdx] = holidayToSave;
                else newHolidays.push(holidayToSave);
                
                // Sort by month then day
                newHolidays.sort((a, b) => {
                    if (a.month !== b.month) return a.month - b.month;
                    return a.day - b.day;
                });

                setLocalHolidays(newHolidays);
                onUpdateHolidays(newHolidays);
                setForm({ name: '', description: '', month: 1, day: 1, color: '#eab308', iconName: 'Star' });
                setEditIdx(-1);
            };

            const deleteHoliday = (idx) => {
                if(confirm('Delete this holiday?')) {
                    const n = localHolidays.filter((_,i)=>i!==idx);
                    setLocalHolidays(n);
                    onUpdateHolidays(n);
                    if (editIdx === idx) {
                        setForm({ name: '', description: '', month: 1, day: 1, color: '#eab308', iconName: 'Star' });
                        setEditIdx(-1);
                    }
                }
            };

            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div className="bg-gray-900 border border-gray-700 w-full max-w-4xl rounded-2xl h-[85vh] sm:h-[650px] flex flex-col overflow-hidden shadow-2xl">
                        <div className="flex justify-between items-center p-4 border-b border-gray-800">
                            <div className="flex items-center gap-2">
                                <Flag className="text-yellow-500"/>
                                <h2 className="text-lg font-bold text-white">Holiday Library</h2>
                            </div>
                            <button onClick={onClose}><X className="text-gray-400 hover:text-white"/></button>
                        </div>

                        <div className="flex flex-col sm:flex-row flex-1 overflow-hidden min-h-0">
                            {/* List of Holidays */}
                            <div className="w-full sm:w-1/3 h-[250px] sm:h-full border-b sm:border-b-0 sm:border-r border-gray-800 p-4 overflow-y-auto space-y-2 shrink-0 custom-scrollbar">
                                <button onClick={()=>{setEditIdx(-1); setForm({ name: '', description: '', month: 1, day: 1, color: '#eab308', iconName: 'Star' })}} className="w-full py-2 border-2 border-dashed border-gray-700 text-gray-500 rounded hover:border-yellow-500 text-sm font-bold mb-4">+ Add Holiday</button>
                                {localHolidays.map((h, i) => {
                                    const IconComp = ICON_OPTIONS[h.iconName] || Star;
                                    return (
                                        <div key={h.id} onClick={()=>{setEditIdx(i); setForm(h);}} className={`p-3 rounded cursor-pointer flex items-center gap-3 ${editIdx===i?'bg-gray-800 border border-yellow-500/50':'bg-gray-900 border border-gray-800 hover:border-gray-700'}`}>
                                            <div className="w-8 h-8 rounded-lg flex items-center justify-center bg-gray-800 shrink-0" style={{color: h.color}}>
                                                <IconComp size={16} />
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="font-bold text-sm text-white truncate">{h.name}</div>
                                                <div className="text-[10px] text-gray-400 uppercase">{monthNames[h.month - 1]} {h.day}</div>
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>

                            {/* Holiday Editor Form */}
                            <div className="w-full sm:w-2/3 flex-1 overflow-y-auto p-4 sm:p-6 space-y-5 custom-scrollbar">
                                <div>
                                    <label className="text-xs text-gray-400 font-bold uppercase tracking-wide">Holiday Name</label>
                                    <input className="w-full bg-gray-800 border border-gray-700 rounded p-2.5 text-white mt-1" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} placeholder="e.g. New Year's Day" />
                                </div>
                                
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-xs text-gray-400 font-bold uppercase tracking-wide">Month</label>
                                        <select className="w-full bg-gray-800 border border-gray-700 rounded p-2.5 text-white mt-1" value={form.month} onChange={e=>setForm({...form, month: parseInt(e.target.value)})}>
                                            {monthNames.map((m, i) => <option key={i+1} value={i+1}>{m}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-400 font-bold uppercase tracking-wide">Day</label>
                                        <select className="w-full bg-gray-800 border border-gray-700 rounded p-2.5 text-white mt-1" value={form.day} onChange={e=>setForm({...form, day: parseInt(e.target.value)})}>
                                            {Array.from({length: 31}, (_, i) => i + 1).map(d => <option key={d} value={d}>{d}</option>)}
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <label className="text-xs text-gray-400 font-bold uppercase tracking-wide">Highlight Color</label>
                                    <div className="flex gap-2 mt-1">
                                        <input type="color" className="w-10 h-10 rounded cursor-pointer bg-gray-800 border border-gray-700 p-0.5" value={form.color} onChange={e=>setForm({...form, color:e.target.value})} />
                                        <div className="flex-1 flex gap-2 flex-wrap items-center">
                                            {['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#a855f7', '#ec4899', '#64748b'].map(c => (
                                                <button key={c} onClick={()=>setForm({...form, color:c})} className={`w-6 h-6 rounded-full border-2 ${form.color===c ? 'border-white' : 'border-transparent'}`} style={{backgroundColor: c}}></button>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label className="text-xs text-gray-400 font-bold uppercase tracking-wide mb-2 block">Select Icon</label>
                                    <div className="grid grid-cols-5 sm:grid-cols-8 gap-2">
                                        {Object.entries(ICON_OPTIONS).map(([name, IconComp]) => (
                                            <button 
                                                key={name} 
                                                onClick={()=>setForm({...form, iconName: name})}
                                                className={`p-2.5 rounded-lg flex items-center justify-center transition-colors ${form.iconName === name ? 'bg-gray-700 ring-2 ring-yellow-500' : 'bg-gray-800 hover:bg-gray-700 text-gray-400'}`}
                                            >
                                                <IconComp size={18} style={{ color: form.iconName === name ? form.color : undefined }}/>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <label className="text-xs text-gray-400 font-bold uppercase tracking-wide">Description (Optional)</label>
                                    <textarea className="w-full bg-gray-800 border border-gray-700 rounded p-2.5 text-white mt-1 min-h-[80px]" value={form.description} onChange={e=>setForm({...form, description:e.target.value})} placeholder="Information about this holiday..." />
                                </div>

                                <div className="pt-4 flex justify-end gap-2 border-t border-gray-800">
                                    {editIdx > -1 && <button onClick={()=>deleteHoliday(editIdx)} className="text-red-400 text-xs mr-auto hover:underline font-bold px-2">Delete Holiday</button>}
                                    <button onClick={saveHoliday} className="bg-yellow-600 hover:bg-yellow-500 text-white px-6 py-2 rounded-lg text-sm font-bold">Save Holiday</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const PendingSummaryModal = ({ isOpen, onClose, projects, clients, showRates, onMarkPaid }) => {
            const [selectedIds, setSelectedIds] = useState([]);

            useEffect(() => {
                if (isOpen) setSelectedIds([]);
            }, [isOpen]);

            if (!isOpen) return null;

            const handleToggle = (id) => {
                setSelectedIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
            };

            const toggleAll = (projectIds) => {
                const allSelected = projectIds.every(id => selectedIds.includes(id));
                if (allSelected) {
                    setSelectedIds(prev => prev.filter(id => !projectIds.includes(id)));
                } else {
                    const newIds = new Set([...selectedIds, ...projectIds]);
                    setSelectedIds(Array.from(newIds));
                }
            };

            // Group by Client | Project
            const grouped = {};
            projects.forEach(p => {
                const key = `${p.client} ${p.projectName ? `| ${p.projectName}` : ''}`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(p);
            });

            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div className="bg-gray-900 border border-yellow-600/50 w-full max-w-3xl rounded-2xl h-[80vh] flex flex-col overflow-hidden shadow-2xl">
                        <div className="flex justify-between items-center p-4 border-b border-gray-800 bg-gray-950/50">
                            <div className="flex items-center gap-2">
                                <Clock className="text-yellow-500"/>
                                <h2 className="text-lg font-bold text-white">Pending Payment Summary</h2>
                            </div>
                            <button onClick={onClose}><X className="text-gray-400 hover:text-white"/></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 sm:p-6 custom-scrollbar">
                            {Object.keys(grouped).length === 0 && <div className="text-center text-gray-500 py-10 italic">No pending items.</div>}
                            
                            {Object.entries(grouped).map(([groupName, items]) => {
                                const groupIds = items.map(i => i.id);
                                const allChecked = groupIds.every(id => selectedIds.includes(id));
                                
                                return (
                                    <div key={groupName} className="mb-8">
                                        <div className="flex items-center gap-3 mb-3 border-b border-gray-700 pb-2">
                                            <input type="checkbox" checked={allChecked} onChange={() => toggleAll(groupIds)} className="accent-yellow-500 w-4 h-4 cursor-pointer" />
                                            <h3 className="font-bold text-white text-sm uppercase tracking-wide text-yellow-500">{groupName}</h3>
                                        </div>
                                        <div className="space-y-2">
                                            {items.map(p => {
                                                const val = getProjectRate(p, clients);
                                                return (
                                                    <div key={p.id} className={`flex items-center gap-4 bg-gray-800 p-3 rounded-lg border transition ${selectedIds.includes(p.id) ? 'border-yellow-500/50 bg-gray-800/80' : 'border-gray-700 hover:border-gray-600'}`}>
                                                        <input type="checkbox" checked={selectedIds.includes(p.id)} onChange={() => handleToggle(p.id)} className="accent-yellow-500 w-4 h-4 cursor-pointer" />
                                                        <div className="flex-1 min-w-0 pr-2">
                                                            <h4 className="text-sm font-bold text-gray-200 truncate">{p.name}</h4>
                                                            {p.notes && <p className="text-xs text-gray-400 truncate mt-0.5">{stripHtml(p.notes)}</p>}
                                                            <div className="text-[10px] text-gray-500 mt-1">
                                                                Done: {p.updatedAt ? parseLocalDate(p.updatedAt).toLocaleDateString() : parseLocalDate(p.createdAt).toLocaleDateString()}
                                                                {p.payType === 'monthly_salary' && '  (Salary)'}
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="text-sm font-mono font-bold text-yellow-400">{showRates ? `$${val.toLocaleString()}` : '****'}</div>
                                                        </div>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                        <div className="p-4 border-t border-gray-800 bg-gray-950/50 flex justify-between items-center">
                            <span className="text-gray-400 text-sm font-bold">{selectedIds.length} shots selected</span>
                            <button 
                                onClick={() => { onMarkPaid(selectedIds); onClose(); }} 
                                disabled={selectedIds.length === 0}
                                className={`px-6 py-2.5 rounded-lg text-sm font-bold flex items-center shadow-lg transition ${selectedIds.length > 0 ? 'bg-emerald-600 hover:bg-emerald-500 text-white' : 'bg-gray-800 text-gray-500 cursor-not-allowed'}`}
                            >
                                <CheckCircle size={16} className="mr-2" />
                                Mark as Paid
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ArchiveModal = ({ isOpen, onClose, projects, clients, onRestore, showRates }) => {
            if(!isOpen) return null;
            
            // Group by Month -> Project
            const grouped = {};
            projects.forEach(p => {
                const date = parseLocalDate(p.paymentDate || p.updatedAt || p.createdAt) || new Date();
                const monthYear = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                const projectKey = `${p.client} ${p.projectName ? `| ${p.projectName}` : ''}`;
                
                if (!grouped[monthYear]) grouped[monthYear] = {};
                if (!grouped[monthYear][projectKey]) grouped[monthYear][projectKey] = [];
                grouped[monthYear][projectKey].push(p);
            });

            // Sort months descending
            const sortedMonths = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div className="bg-gray-900 border border-gray-700 w-full max-w-5xl rounded-2xl h-[85vh] flex flex-col overflow-hidden shadow-2xl">
                        <div className="flex justify-between items-center p-4 border-b border-gray-800 bg-gray-950/50">
                            <div className="flex items-center gap-2">
                                <FolderOpen className="text-emerald-500"/>
                                <h2 className="text-lg font-bold text-white">Paid Projects Archive</h2>
                            </div>
                            <button onClick={onClose}><X className="text-gray-400 hover:text-white"/></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 sm:p-6 custom-scrollbar space-y-10">
                            {sortedMonths.length === 0 && <div className="col-span-full text-center text-gray-600 py-10">No paid projects yet.</div>}
                            
                            {sortedMonths.map(month => {
                                let monthlyTotal = 0;
                                Object.values(grouped[month]).flat().forEach(p => monthlyTotal += getProjectRate(p, clients));

                                return (
                                    <div key={month} className="relative">
                                        <div className="flex justify-between items-end mb-4 border-b border-emerald-900/50 pb-2">
                                            <h3 className="text-emerald-400 font-bold text-xl">{month}</h3>
                                            <span className="text-emerald-500/70 font-mono text-sm font-bold">{showRates ? `Total: $${monthlyTotal.toLocaleString()}` : 'Total: ****'}</span>
                                        </div>
                                        
                                        <div className="space-y-6">
                                            {Object.entries(grouped[month]).map(([projName, items]) => (
                                                <div key={projName}>
                                                    <h4 className="text-gray-400 font-semibold text-xs mb-3 pl-3 border-l-2 border-gray-600 uppercase tracking-wide">{projName}</h4>
                                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pl-3">
                                                        {items.map(p => {
                                                            const val = getProjectRate(p, clients);
                                                            return (
                                                                <div key={p.id} className="bg-gray-800 p-3 rounded-xl border border-gray-700 opacity-90 hover:opacity-100 transition group relative">
                                                                    <button 
                                                                        onClick={(e) => { e.stopPropagation(); onRestore(p); }} 
                                                                        className="absolute top-2 right-2 p-1.5 bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition" 
                                                                        title="Restore to Pending"
                                                                    >
                                                                        <RotateCcw size={14} />
                                                                    </button>
                                                                    <h4 className="font-bold text-sm text-white mb-2 pr-6 truncate">{p.name}</h4>
                                                                    <div className="flex justify-between items-end text-[10px] text-gray-500">
                                                                        <div className="flex flex-col">
                                                                            <span>Paid: {p.paymentDate ? new Date(p.paymentDate).toLocaleDateString() : '-'}</span>
                                                                            <span>{p.payType === 'monthly_salary' ? 'Salary' : 'Task'}</span>
                                                                        </div>
                                                                        <span className="text-sm font-mono text-emerald-400 font-bold">{showRates ? `$${val.toLocaleString()}` : '****'}</span>
                                                                    </div>
                                                                </div>
                                                            )
                                                        })}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const ProjectCard = ({ project, clients, onEdit, onViewDetails, moveStatus, onToggleActive, showRates }) => {
            const client = clients.find(c => c.name === project.client);
            const mode = client?.mode || 'per_shot';
            
            let val = 0;
            let label = '';
            
            if (mode === 'monthly') {
                 if (project.payType === 'monthly_salary') {
                    val = project.fixedPrice || client?.defaultRate || 0;
                    label = '(Monthly Salary)';
                 } else {
                    val = 0;
                    label = '(Covered)';
                 }
            } else if (mode === 'per_project') {
                val = project.fixedPrice || 0;
                label = '(Project Total)';
            } else {
                val = (project.shotRate || 0) * (project.shotCount || 0);
            }
            
            const isActiveWorking = project.isWorkingOn;
            
            // FIX: Use local time for 'today' to prevent timezone lag issues
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            const deadline = parseLocalDate(project.deadline);
            const start = parseLocalDate(project.startDate) || parseLocalDate(project.createdAt) || today;
            
            let isOverdue = false;
            let timeProg = 0;
            let timeColor = 'bg-blue-400';
            let daysLeftText = '';

            if (deadline && project.status !== 'paid' && project.status !== 'completed') {
                const totalDays = getDayDiff(start, deadline);
                const elapsedDays = getDayDiff(start, today);
                const remainingDays = getDayDiff(today, deadline);

                if (totalDays > 0) {
                    timeProg = Math.max(0, Math.min(100, (elapsedDays / totalDays) * 100));
                } else if (elapsedDays > 0) timeProg = 100;

                if (remainingDays < 0) {
                    isOverdue = true;
                    timeProg = 100;
                    timeColor = 'bg-red-500';
                    daysLeftText = 'Overdue';
                } else {
                    daysLeftText = remainingDays === 0 ? 'Due Today' : `${remainingDays} days left`;
                    if (timeProg > 90) timeColor = 'bg-red-500';
                    else if (timeProg > 75) timeColor = 'bg-orange-500';
                }
            }

            let stageColor = 'text-gray-400 border-gray-600';
            if(['layout','blocking','splining','polishing'].includes(project.status)) stageColor = 'text-blue-400 border-blue-500/50 bg-blue-900/10';
            else if(project.status === 'completed') stageColor = 'text-yellow-400 border-yellow-500/50 bg-yellow-900/10';
            else if(project.status === 'paid') stageColor = 'text-emerald-400 border-emerald-500/50 bg-emerald-900/10';

            return (
                <div onClick={() => onViewDetails(project)} className={`rounded-xl p-3 shadow-md active:scale-95 transition-transform group relative border-l-4 min-w-[200px] sm:min-w-[260px] flex-shrink-0 ${isOverdue ? 'border-red-500' : (isActiveWorking ? 'border-blue-500' : 'border-gray-700')} ${isActiveWorking ? 'bg-blue-900/20' : 'bg-gray-800'}`}>
                    <div className="flex justify-between items-start mb-2">
                        <div className="flex-1 pr-2 overflow-hidden">
                            <div className="flex items-center text-[10px] text-gray-500 font-semibold mb-0.5 truncate uppercase tracking-wider">
                                {project.client} {project.projectName && <span className="mx-1 opacity-50">/ {project.projectName}</span>}
                            </div>
                            <h4 className="font-bold text-sm text-white truncate">{project.name}</h4>
                        </div>
                        <div className="flex space-x-1">
                            <button onClick={(e) => { e.stopPropagation(); onToggleActive(project); }} className={`p-1 rounded transition-colors ${isActiveWorking ? 'text-blue-400' : 'text-gray-600 hover:text-white'}`}>
                                <Target size={14} fill={isActiveWorking ? "currentColor" : "none"} />
                            </button>
                            <button onClick={(e) => { e.stopPropagation(); onEdit(project); }} className="text-gray-500 hover:text-white p-1 hover:bg-gray-700 rounded"><Edit2 size={14} /></button>
                        </div>
                    </div>

                    <div className="flex items-center justify-between mb-2">
                        <div className={`flex items-center px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide border ${stageColor}`}>
                            {project.status === 'completed' ? 'Done' : project.status}
                        </div>
                        <div className="text-right">
                             <span className={`text-xs font-mono font-bold ${mode === 'monthly' && project.payType !== 'monthly_salary' ? 'text-purple-400' : 'text-emerald-400'}`}>
                                {showRates ? (val > 0 ? `$${val.toLocaleString()}` : 'Included') : '****'}
                            </span>
                            {label && <div className="text-[9px] text-gray-500">{label}</div>}
                        </div>
                    </div>
                    
                    <div className="space-y-1.5">
                        <div className="w-full bg-gray-700 rounded-full h-1 overflow-hidden mb-1">
                            <div className="bg-blue-500 h-1 rounded-full" style={{width: `${project.progress||0}%`}}></div>
                        </div>
                        {deadline && (
                            <div>
                                <div className="w-full bg-gray-700 rounded-full h-1 overflow-hidden relative">
                                    <div className={`${timeColor} h-1 rounded-full transition-all duration-500`} style={{width: `${timeProg}%`}}></div>
                                </div>
                                <div className="flex justify-between items-center pt-1">
                                    <span className={`text-[10px] flex items-center ${isOverdue ? 'text-red-400 font-bold' : 'text-gray-500'}`}>
                                        <Clock size={10} className="mr-1"/> 
                                        {daysLeftText}
                                    </span>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {project.status !== 'paid' && (
                        <div className="mt-2 pt-2 border-t border-gray-700/50 flex justify-end">
                             <button onClick={(e) => { e.stopPropagation(); moveStatus(project, 'forward'); }} className="text-[10px] bg-gray-700 hover:bg-gray-600 text-white px-2 py-1 rounded flex items-center shadow-sm border border-gray-600">
                                Next <ArrowRight size={10} className="ml-1"/>
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        const ProjectDetails = ({ project, onClose, onUpdate, onEdit }) => {
            const [notes, setNotes] = useState(project.notes || '');
            const [progress, setProgress] = useState(project.progress || 0);
            const timer = useRef(null);
            
            const changeNotes = (html) => { 
                setNotes(html); 
                clearTimeout(timer.current); 
                timer.current = setTimeout(() => onUpdate(project.id, { notes: html, progress }), 1000); 
            };
            
            const changeProg = (e) => { 
                setProgress(e.target.value); 
                clearTimeout(timer.current); 
                timer.current = setTimeout(() => onUpdate(project.id, { notes, progress: e.target.value }), 500); 
            };

            return (
                <div className="fixed inset-0 z-50 flex justify-end">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />
                    <div className="relative w-full max-w-2xl bg-gray-900 h-full border-l border-gray-800 shadow-2xl flex flex-col">
                        <div className="p-4 border-b border-gray-800 bg-gray-900 z-10 flex justify-between items-start">
                            <div>
                                <h2 className="text-xl font-bold text-white">{project.name}</h2>
                                <p className="text-gray-400 text-sm">{project.client}</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={onEdit}><Edit2 className="text-gray-400 hover:text-white"/></button>
                                <button onClick={onClose}><X className="text-gray-400 hover:text-white"/></button>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-4">
                            <div className="bg-gray-800 p-4 rounded-xl border border-gray-700">
                                <div className="flex justify-between mb-2 text-sm font-bold text-gray-300"><span>Progress</span><span className="text-blue-400">{progress}%</span></div>
                                <input type="range" min="0" max="100" value={progress} onChange={changeProg} className="w-full h-2 bg-gray-700 rounded-lg accent-blue-500" />
                            </div>
                            
                            {/* Rich Text Editor Replacement */}
                            <div className="space-y-2">
                                <label className="text-xs text-gray-500 font-bold uppercase tracking-wider">Project Notes</label>
                                <RichTextEditor value={notes} onChange={changeNotes} />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ListManager = ({ isOpen, onClose, onUpdateLists, initialClients, allData, onImport }) => {
            const [activeTab, setActiveTab] = useState('clients');
            const [clients, setClients] = useState(initialClients);
            const [form, setForm] = useState({ name: '', mode: 'per_shot', defaultRate: 0, payDay: 25, projects: [] });
            const [projectInput, setProjectInput] = useState('');
            const [editIdx, setEditIdx] = useState(-1);
            const fileRef = useRef(null);

            useEffect(() => { setClients(initialClients); }, [initialClients, isOpen]);
            if (!isOpen) return null;

            const addProjectToClient = () => {
                if(projectInput) {
                    setForm({...form, projects: [...(form.projects||[]), projectInput]});
                    setProjectInput('');
                }
            };
            const removeProjectFromClient = (idx) => {
                setForm({...form, projects: form.projects.filter((_, i) => i !== idx)});
            };
            const saveClient = () => {
                if(!form.name) return;
                const newClients = [...clients];
                if(editIdx > -1) newClients[editIdx] = form;
                else newClients.push(form);
                setClients(newClients);
                onUpdateLists(newClients);
                setForm({ name: '', mode: 'per_shot', defaultRate: 0, payDay: 25, projects: [] });
                setEditIdx(-1);
            };
            const deleteClient = (idx) => {
                if(confirm('Delete?')) {
                    const n = clients.filter((_,i)=>i!==idx);
                    setClients(n);
                    onUpdateLists(n);
                }
            };
            const exportData = () => {
                const blob = new Blob([JSON.stringify(allData,null,2)], {type : 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `animtrack_backup_${new Date().toISOString().split('T')[0]}.json`; a.click();
            };
            const importData = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const r = new FileReader();
                r.onload = (ev) => {
                    try {
                        const d = JSON.parse(ev.target.result);
                        if(onImport(d)) {
                            alert('Imported successfully! Updating view...');
                            onClose();
                        } else alert('Invalid file format.');
                    } catch(err) { alert('Error parsing JSON'); }
                };
                r.readAsText(file);
            };

            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div className="bg-gray-900 border border-gray-700 w-full max-w-3xl rounded-2xl h-[85vh] sm:h-[600px] flex flex-col overflow-hidden shadow-2xl">
                        <div className="flex border-b border-gray-800">
                             <button onClick={()=>setActiveTab('clients')} className={`flex-1 py-4 text-sm font-bold ${activeTab==='clients'?'bg-gray-800 text-white border-b-2 border-blue-500':'text-gray-400'}`}>Clients</button>
                             <button onClick={()=>setActiveTab('data')} className={`flex-1 py-4 text-sm font-bold ${activeTab==='data'?'bg-gray-800 text-white border-b-2 border-emerald-500':'text-gray-400'}`}>Data Backup</button>
                             <button onClick={onClose} className="px-6 text-gray-400 hover:text-white"><X/></button>
                        </div>

                        <div className="flex-1 overflow-hidden min-h-0">
                            {activeTab === 'clients' ? (
                                <div className="flex flex-col sm:flex-row h-full">
                                    <div className="w-full sm:w-1/3 h-[250px] sm:h-full border-b sm:border-b-0 sm:border-r border-gray-800 p-4 overflow-y-auto space-y-2 shrink-0">
                                        <button onClick={()=>{setEditIdx(-1); setForm({ name: '', mode: 'per_shot', defaultRate: 0, payDay: 25, projects: [] })}} className="w-full py-2 border-2 border-dashed border-gray-700 text-gray-500 rounded hover:border-blue-500 text-sm font-bold">+ New Client</button>
                                        {clients.map((c, i) => (
                                            <div key={i} onClick={()=>{setEditIdx(i); setForm(c);}} className={`p-3 rounded cursor-pointer ${editIdx===i?'bg-blue-900/20 border border-blue-500/50':'bg-gray-800 border border-gray-700 hover:border-gray-600'}`}>
                                                <div className="font-bold text-sm text-white">{c.name}</div>
                                                <div className="text-[10px] text-gray-400 uppercase">{(c.mode || 'per_shot').replace('_',' ')}</div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="w-full sm:w-2/3 flex-1 overflow-y-auto p-4 sm:p-6 space-y-4">
                                        <div>
                                            <label className="text-xs text-gray-400">Client Name</label>
                                            <input className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-400">Payment Mode</label>
                                            <div className="flex gap-2">
                                                {['per_shot', 'per_project', 'monthly'].map(m => (
                                                    <button key={m} onClick={()=>setForm({...form, mode:m})} className={`flex-1 py-2 text-xs border rounded capitalize ${form.mode===m?'bg-blue-600 border-blue-500 text-white':'border-gray-700 text-gray-400'}`}>{m.replace('_',' ')}</button>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-xs text-gray-400">{form.mode === 'monthly' ? 'Monthly Salary' : 'Default Rate'}</label>
                                                <input type="number" className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white" value={form.defaultRate} onChange={e=>setForm({...form, defaultRate:e.target.value})} />
                                            </div>
                                            {form.mode === 'monthly' && (
                                                <div>
                                                    <label className="text-xs text-gray-400">Pay Day</label>
                                                    <input type="number" className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white" value={form.payDay} onChange={e=>setForm({...form, payDay:e.target.value})} />
                                                </div>
                                            )}
                                        </div>
                                        <div className="border-t border-gray-800 pt-4">
                                            <label className="text-xs text-gray-400 mb-2 block">Projects / Shows</label>
                                            <div className="flex gap-2 mb-2">
                                                <input className="flex-1 bg-gray-800 border border-gray-700 rounded p-2 text-xs text-white" placeholder="Add Project..." value={projectInput} onChange={e=>setProjectInput(e.target.value)} />
                                                <button onClick={addProjectToClient} className="bg-gray-700 px-3 rounded text-white"><Plus size={14}/></button>
                                            </div>
                                            <div className="flex flex-wrap gap-2">
                                                {(form.projects||[]).map((p, idx) => (
                                                    <span key={idx} className="bg-gray-800 border border-gray-600 text-xs px-2 py-1 rounded flex items-center">
                                                        {p} <button onClick={()=>removeProjectFromClient(idx)} className="ml-1 text-red-400"><X size={10}/></button>
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="pt-4 flex justify-end gap-2">
                                            {editIdx > -1 && <button onClick={()=>{
                                                const n = clients.filter((_,i)=>i!==editIdx);
                                                setClients(n); onUpdateLists(n); setEditIdx(-1); setForm({ name: '', mode: 'per_shot', defaultRate: 0, payDay: 25, projects: [] });
                                            }} className="text-red-400 text-xs mr-auto">Delete Client</button>}
                                            <button onClick={saveClient} className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm font-bold">Save Changes</button>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="flex flex-col items-center justify-center h-full space-y-6">
                                    <div className="text-center">
                                        <FileJson size={48} className="mx-auto text-gray-600 mb-4" />
                                        <h3 className="text-xl font-bold text-white">Data Management</h3>
                                        <p className="text-gray-400 text-sm mt-1">Export your data to JSON or restore from a backup.</p>
                                    </div>
                                    <div className="flex gap-4">
                                        <button onClick={exportData} className="flex flex-col items-center p-6 bg-gray-800 border border-gray-700 rounded-xl hover:border-emerald-500 transition group">
                                            <Download className="mb-2 text-emerald-500 group-hover:scale-110 transition-transform"/> 
                                            <span className="text-white font-bold">Export Backup</span>
                                        </button>
                                        <button onClick={()=>fileRef.current.click()} className="flex flex-col items-center p-6 bg-gray-800 border border-gray-700 rounded-xl hover:border-blue-500 transition group">
                                            <Upload className="mb-2 text-blue-500 group-hover:scale-110 transition-transform"/> 
                                            <span className="text-white font-bold">Import Backup</span>
                                        </button>
                                        <input type="file" ref={fileRef} className="hidden" accept=".json" onChange={importData} />
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const ProjectModal = ({ isOpen, onClose, onSave, onDelete, initialData, clients }) => {
            const [form, setForm] = useState({});
            const [selectedClient, setSelectedClient] = useState(null);

            useEffect(() => {
                if(isOpen) {
                    if(initialData) {
                        setForm({...initialData});
                        const c = clients.find(cl => cl.name === initialData.client);
                        setSelectedClient(c);
                    } else {
                        const defC = clients[0];
                        setSelectedClient(defC);
                        let defPayType = 'per_shot';
                        let defPrice = 0;
                        if(defC) {
                            if(defC.mode === 'per_project') defPayType = 'fixed';
                            if(defC.mode === 'monthly') defPayType = 'monthly_work'; 
                            defPrice = defC.defaultRate || 0;
                        }
                        
                        setForm({
                            name: '', client: defC?.name || '', projectName: '',
                            payType: defPayType,
                            status: 'inquiry',
                            fixedPrice: (defPayType==='fixed') ? defPrice : 0,
                            shotRate: (defPayType==='per_shot') ? defPrice : 0,
                            shotCount: 1,
                            startDate: getLocalDateString(), // FIX: Default to local date string
                            deadline: '',
                            progress: 0,
                            notes: '',
                            isWorkingOn: false
                        });
                    }
                }
            }, [isOpen, initialData, clients]);

            const handleClientChange = (e) => {
                const name = e.target.value;
                const c = clients.find(cl => cl.name === name);
                setSelectedClient(c);
                
                let pt = 'per_shot';
                if(c.mode === 'per_project') pt = 'fixed';
                if(c.mode === 'monthly') pt = 'monthly_work';

                setForm({
                    ...form,
                    client: name,
                    projectName: '',
                    payType: pt,
                    fixedPrice: (pt === 'fixed') ? c.defaultRate : 0,
                    shotRate: (pt === 'per_shot') ? c.defaultRate : 0
                });
            }

            if(!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div className="bg-gray-900 border border-gray-700 w-full max-w-lg rounded-2xl p-6 shadow-2xl flex flex-col max-h-[90vh] overflow-y-auto custom-scrollbar">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-white">{initialData?'Edit':'New'} Task</h2>
                            <button onClick={onClose}><X/></button>
                        </div>

                        <div className="space-y-4">
                            {/* Client & Project */}
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs text-gray-400">Client</label>
                                    <select className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white" value={form.client} onChange={handleClientChange}>
                                        {clients.map(c => <option key={c.name} value={c.name}>{c.name}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs text-gray-400">Project</label>
                                    <select className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white" value={form.projectName} onChange={e=>setForm({...form, projectName:e.target.value})}>
                                        <option value="">Select...</option>
                                        {(selectedClient?.projects || []).map(p => <option key={p} value={p}>{p}</option>)}
                                    </select>
                                </div>
                            </div>

                            {/* Dynamic Payment Inputs */}
                            <div className="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                                {selectedClient?.mode === 'monthly' ? (
                                    <div className="space-y-3">
                                        <div className="flex bg-gray-900 p-1 rounded">
                                            <button type="button" onClick={()=>setForm({...form, payType:'monthly_work', fixedPrice:0})} className={`flex-1 py-1 text-xs rounded ${form.payType==='monthly_work'?'bg-purple-600 text-white':'text-gray-400'}`}>Log Work (Task)</button>
                                            <button type="button" onClick={()=>setForm({...form, payType:'monthly_salary', fixedPrice:selectedClient.defaultRate})} className={`flex-1 py-1 text-xs rounded ${form.payType==='monthly_salary'?'bg-emerald-600 text-white':'text-gray-400'}`}>Log Salary (Payment)</button>
                                        </div>
                                        
                                        {form.payType === 'monthly_salary' ? (
                                            <div className="text-center">
                                                <p className="text-xs text-gray-500">Monthly Payment Amount</p>
                                                <div className="text-xl font-bold text-emerald-400">${form.fixedPrice}</div>
                                            </div>
                                        ) : (
                                            <div className="grid grid-cols-2 gap-4">
                                                <input type="number" placeholder="Shot Rate (Ref)" className="bg-gray-900 border border-gray-700 rounded p-2 text-white" value={form.shotRate} onChange={e=>setForm({...form, shotRate:e.target.value})} />
                                                <input type="number" placeholder="Count" className="bg-gray-900 border border-gray-700 rounded p-2 text-white" value={form.shotCount} onChange={e=>setForm({...form, shotCount:e.target.value})} />
                                                <div className="col-span-2 text-[10px] text-center text-gray-500">Value tracks internal stats only. Income comes from Salary logs.</div>
                                            </div>
                                        )}
                                    </div>
                                ) : selectedClient?.mode === 'per_project' ? (
                                    <div>
                                        <label className="text-xs text-gray-400">Fixed Project Price</label>
                                        <input type="number" className="w-full bg-gray-900 border border-gray-700 rounded p-2 text-white" value={form.fixedPrice} onChange={e=>setForm({...form, fixedPrice:e.target.value})} />
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="text-xs text-gray-400">Shot Rate</label><input type="number" className="bg-gray-900 border border-gray-700 rounded p-2 text-white w-full" value={form.shotRate} onChange={e=>setForm({...form, shotRate:e.target.value})} /></div>
                                        <div><label className="text-xs text-gray-400">Shot Count</label><input type="number" className="bg-gray-900 border border-gray-700 rounded p-2 text-white w-full" value={form.shotCount} onChange={e=>setForm({...form, shotCount:e.target.value})} /></div>
                                    </div>
                                )}
                            </div>

                            <input type="text" placeholder="Task Name" className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} />
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs text-gray-400">Start Date</label>
                                    <input type="date" className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-xs" value={form.startDate} onChange={e=>setForm({...form, startDate:e.target.value})} />
                                </div>
                                <div>
                                    <label className="text-xs text-gray-400">{form.status==='paid'?'Paid Date':'Deadline'}</label>
                                    <input type="date" className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-xs" value={form.status==='paid'?form.paymentDate:form.deadline} onChange={e=>form.status==='paid'?setForm({...form, paymentDate:e.target.value}):setForm({...form, deadline:e.target.value})} />
                                </div>
                            </div>
                            
                            <div>
                                <label className="text-xs text-gray-400">Stage</label>
                                <select className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white" value={form.status} onChange={e=>setForm({...form, status:e.target.value})}>
                                    <option value="inquiry">Inquiry</option>
                                    <option value="layout">Layout</option>
                                    <option value="blocking">Blocking</option>
                                    <option value="splining">Splining</option>
                                    <option value="polishing">Polish</option>
                                    <option value="completed">Done (Pending)</option>
                                    <option value="paid">Paid</option>
                                </select>
                            </div>

                            <div className="flex justify-between pt-4 border-t border-gray-800">
                                {initialData ? <button onClick={()=>onDelete(initialData.id)} className="text-red-400 hover:text-red-300 text-sm">Delete</button> : <div/>}
                                <button onClick={()=>onSave(form)} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded font-bold">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Statistics View (Moved above App) ---
        const StatisticsView = ({ projects, clients, showRates, onOpenPending }) => {
            const { monthlyData, clientData } = useMemo(() => {
                const months = Array.from({length: 12}, (_, i) => ({ 
                    name: new Date(0, i).toLocaleString('default', {month:'short'}), 
                    earned: 0, 
                    projected: 0 
                }));

                const clientStats = {};
                clients.forEach(c => clientStats[c.name] = 0);
                
                projects.forEach(p => {
                    const client = clients.find(c => c.name === p.client);
                    const mode = client?.mode || 'per_shot';
                    const dateRef = p.status === 'paid' ? p.paymentDate : p.deadline;
                    const dateObj = parseLocalDate(dateRef || p.createdAt);
                    if(!dateObj || dateObj.getFullYear() !== new Date().getFullYear()) return;

                    const mIndex = dateObj.getMonth();

                    if (mode === 'monthly') {
                        // Only count monthly_salary tickets
                        if (p.payType === 'monthly_salary') {
                             const val = parseFloat(p.fixedPrice || client.defaultRate || 0);
                             if (p.status === 'paid') {
                                 months[mIndex].earned += val;
                                 clientStats[p.client] += val;
                             } else {
                                 months[mIndex].projected += val;
                             }
                        }
                    } else {
                        let val = (mode === 'per_project') ? parseFloat(p.fixedPrice||0) : (parseFloat(p.shotRate||0) * parseInt(p.shotCount||0));
                        if (p.status === 'paid') {
                            months[mIndex].earned += val;
                            clientStats[p.client] += val;
                        } else {
                            months[mIndex].projected += val;
                        }
                    }
                });

                return { monthlyData: months, clientData: clientStats };
            }, [projects, clients]);

            const maxVal = Math.max(...monthlyData.map(m => m.earned + m.projected), 100);

            return (
                <div className="flex flex-col h-full bg-gray-900 border border-gray-800 rounded-xl shadow-xl overflow-hidden p-6 custom-scrollbar overflow-y-auto">
                    
                    {/* Monthly Chart */}
                    <div className="mb-8">
                        <h3 className="text-white font-bold mb-4 flex items-center"><BarChart2 className="mr-2 text-blue-500" size={20}/> Annual Income Overview</h3>
                        <div className="h-64 w-full flex items-end justify-between space-x-2">
                            {monthlyData.map((m, i) => (
                                <div key={i} className="flex-1 flex flex-col items-center group relative h-full justify-end">
                                    <div className="w-full bg-gray-800/50 rounded-t-sm flex flex-col-reverse relative overflow-hidden h-full">
                                        <div 
                                            className="w-full bg-emerald-500/80 hover:bg-emerald-400 transition-all duration-500 absolute bottom-0" 
                                            style={{ height: `${(m.earned / maxVal) * 100}%` }}
                                            title={showRates ? `Earned: $${m.earned.toLocaleString()}` : 'Earned: ****'}
                                        />
                                        <div 
                                            className="w-full bg-blue-500/30 hover:bg-blue-400/30 transition-all duration-500 absolute" 
                                            style={{ bottom: `${(m.earned / maxVal) * 100}%`, height: `${(m.projected / maxVal) * 100}%` }}
                                            title={showRates ? `Projected: $${m.projected.toLocaleString()}` : 'Projected: ****'}
                                        />
                                    </div>
                                    <span className="text-[10px] text-gray-500 mt-2 uppercase">{m.name}</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Client Breakdown */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-gray-800/50 p-4 rounded-xl border border-gray-800">
                            <h3 className="text-white font-bold mb-4 flex items-center"><Briefcase className="mr-2 text-purple-500" size={20}/> Earnings by Client</h3>
                            <div className="space-y-3">
                                {Object.entries(clientData).sort((a,b) => b[1] - a[1]).map(([name, val], i) => (
                                    <div key={i}>
                                        <div className="flex justify-between text-xs mb-1">
                                            <span className="text-gray-300">{name}</span>
                                            <span className="text-white font-mono">{showRates ? `$${val.toLocaleString()}` : '****'}</span>
                                        </div>
                                        <div className="w-full bg-gray-700 h-2 rounded-full overflow-hidden">
                                            <div className="bg-purple-500 h-full" style={{ width: `${(val / Math.max(...Object.values(clientData), 1)) * 100}%` }}></div>
                                        </div>
                                    </div>
                                ))}
                                {Object.keys(clientData).length === 0 && <div className="text-gray-500 text-sm italic">No paid data yet.</div>}
                            </div>
                        </div>

                        <div className="bg-gray-800/50 p-4 rounded-xl border border-gray-800">
                            <h3 className="text-white font-bold mb-4 flex items-center"><Layers className="mr-2 text-yellow-500" size={20}/> Task Distribution</h3>
                            <div className="space-y-2">
                                <div className="flex justify-between items-center p-2 bg-gray-900 rounded border border-gray-700">
                                    <div className="flex items-center text-sm text-blue-400"><Layers size={14} className="mr-2"/> Active Work</div>
                                    <span className="font-bold text-white">{projects.filter(p=>!['paid','completed'].includes(p.status)).length}</span>
                                </div>
                                <div onClick={onOpenPending} className="flex justify-between items-center p-2 bg-gray-900 rounded border border-gray-700 cursor-pointer hover:bg-gray-800 transition">
                                    <div className="flex items-center text-sm text-yellow-400"><CheckCircle size={14} className="mr-2"/> Done (Pending)</div>
                                    <span className="font-bold text-white">{projects.filter(p=>p.status==='completed').length}</span>
                                </div>
                                <div className="flex justify-between items-center p-2 bg-gray-900 rounded border border-gray-700">
                                    <div className="flex items-center text-sm text-emerald-400"><DollarSign size={14} className="mr-2"/> Paid & Archived</div>
                                    <span className="font-bold text-white">{projects.filter(p=>p.status==='paid').length}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main Application ---
        function App() {
            const [data, setData] = useState({ projects: [], clients: [], holidays: [], leaves: [], totalLeaves: 24 });
            const [loading, setLoading] = useState(true);
            const [viewMode, setViewMode] = useState('board'); 
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isListManagerOpen, setIsListManagerOpen] = useState(false);
            const [isHolidayManagerOpen, setIsHolidayManagerOpen] = useState(false);
            const [isArchiveOpen, setIsArchiveOpen] = useState(false); 
            const [isPendingSummaryOpen, setIsPendingSummaryOpen] = useState(false);
            const [editingProject, setEditingProject] = useState(null);
            const [viewingProject, setViewingProject] = useState(null);
            const [currentDate, setCurrentDate] = useState(new Date());
            const [filterByMonth, setFilterByMonth] = useState(false);
            const [showStats, setShowStats] = useState(false); 
            const [showRates, setShowRates] = useState(true);

            useEffect(() => {
                const loaded = loadData();
                setData(loaded);
                setLoading(false);
            }, []);

            useEffect(() => {
                if (!loading) saveData(data);
            }, [data, loading]);

            const handleUpdateLists = (newClients) => {
                setData(prev => ({ ...prev, clients: newClients }));
            };

            const handleUpdateHolidays = (newHolidays) => {
                setData(prev => ({ ...prev, holidays: newHolidays }));
            };

            const handleAddLeave = (leave) => {
                setData(prev => ({ ...prev, leaves: [...(prev.leaves || []), leave] }));
            };

            const handleDeleteLeave = (id) => {
                setData(prev => ({ ...prev, leaves: (prev.leaves || []).filter(l => l.id !== id) }));
            };

            const handleSaveProject = (formProject) => {
                const now = new Date().toISOString();
                let updatedProjects;
                if (editingProject) {
                    updatedProjects = data.projects.map(p => p.id === editingProject.id ? { ...p, ...formProject, updatedAt: now } : p);
                } else {
                    const newProject = { ...formProject, id: crypto.randomUUID(), createdAt: now, updatedAt: now };
                    updatedProjects = [...data.projects, newProject];
                }
                setData(prev => ({ ...prev, projects: updatedProjects }));
                setIsModalOpen(false);
                setEditingProject(null);
            };

            const handleDeleteProject = (id) => {
                setData(prev => ({ ...prev, projects: prev.projects.filter(p => p.id !== id) }));
                if (viewingProject?.id === id) setViewingProject(null);
                setIsModalOpen(false);
            };

            const handleUpdateNotes = (projectId, updates) => {
                setData(prev => ({ ...prev, projects: prev.projects.map(p => p.id === projectId ? { ...p, ...updates } : p) }));
                if (viewingProject?.id === projectId) setViewingProject(prev => ({ ...prev, ...updates }));
            };

            const handleToggleActive = (project) => {
                const isNowActive = !project.isWorkingOn;
                setData(prev => ({ ...prev, projects: prev.projects.map(p => p.id === project.id ? { ...p, isWorkingOn: isNowActive } : p) }));
            };

            const handleMoveStatus = (project, direction) => {
                const flow = ['inquiry', 'layout', 'blocking', 'splining', 'polishing', 'completed', 'paid'];
                const currentIndex = flow.indexOf(project.status);
                let newIndex = currentIndex;
                if (direction === 'forward' && currentIndex < flow.length - 1) newIndex++;
                if (direction === 'back' && currentIndex > 0) newIndex--;

                if (newIndex !== currentIndex) {
                    const newStatus = flow[newIndex];
                    const todayStr = getLocalDateString();
                    let updates = { status: newStatus };
                    if (newStatus === 'paid' && !project.paymentDate) updates.paymentDate = todayStr;
                    
                    // Simple update for now, batch logic removed for simplicity in this structural update
                    setData(prev => ({
                        ...prev,
                        projects: prev.projects.map(p => p.id === project.id ? { ...p, ...updates } : p)
                    }));
                }
            };

            const handleBatchMarkPaid = (ids) => {
                if (ids.length === 0) return;
                const todayStr = getLocalDateString();
                setData(prev => ({
                    ...prev,
                    projects: prev.projects.map(p => 
                        ids.includes(p.id) ? { ...p, status: 'paid', paymentDate: todayStr } : p
                    )
                }));
            };

            const handleRestoreProject = (project) => {
                if (confirm(`Restore "${project.name}" to Pending Pay?`)) {
                    setData(prev => ({
                        ...prev,
                        projects: prev.projects.map(p => 
                            p.id === project.id ? { ...p, status: 'completed', paymentDate: '' } : p
                        )
                    }));
                }
            };

            const handleImportData = (importedData) => {
                if (importedData.projects && importedData.clients) {
                    setData({ 
                        projects: importedData.projects || [], 
                        clients: importedData.clients || [],
                        holidays: importedData.holidays || [],
                        leaves: importedData.leaves || [],
                        totalLeaves: importedData.totalLeaves ?? 24
                    });
                    return true;
                }
                return false;
            };

            const changeMonth = (dir) => {
                const d = new Date(currentDate);
                d.setMonth(currentDate.getMonth() + dir);
                setCurrentDate(d);
            };

            const isSameMonth = (dStr, target) => {
                if (!dStr) return false;
                const date = parseLocalDate(dStr);
                return date.getMonth() === target.getMonth() && date.getFullYear() === target.getFullYear();
            };

            const stats = useMemo(() => {
                let monthlyEarned = 0, monthlyProjected = 0, pendingPayment = 0;
                
                // Track Unique Groups to avoid double counting
                const groups = {}; 

                data.projects.forEach(p => {
                    const client = data.clients.find(c => c.name === p.client);
                    const mode = client?.mode || 'per_shot';
                    const dateRef = p.status === 'paid' ? p.paymentDate : p.deadline;
                    
                    if (!isSameMonth(dateRef, currentDate)) return;

                    if (mode === 'per_shot') {
                        const val = (parseFloat(p.shotRate||0) * parseInt(p.shotCount||0));
                        if (p.status === 'paid') monthlyEarned += val;
                        else if (p.status === 'completed') pendingPayment += val;
                        else monthlyProjected += val; 
                    } 
                    else {
                        // Monthly or Per Project: Needs Grouping
                        let key = '';
                        let rate = 0;

                        if (mode === 'monthly') {
                            key = `monthly_${p.client}`;
                            rate = parseFloat(client.defaultRate || 0);
                        } else if (mode === 'per_project') {
                            key = `project_${p.client}_${p.projectName || 'default'}`;
                            rate = parseFloat(p.fixedPrice || 0);
                        }

                        if (!groups[key]) {
                            groups[key] = { rate: rate, statusWeight: 0 }; 
                        }
                        
                        if (mode === 'per_project' && rate > groups[key].rate) groups[key].rate = rate;

                        // Priority: Paid > Pending > Active
                        let weight = 1; 
                        if (p.status === 'paid') weight = 3;
                        else if (p.status === 'completed') weight = 2;
                        else if (p.status === 'inquiry') weight = 0;
                        
                        if (weight > groups[key].statusWeight) {
                            groups[key].statusWeight = weight;
                        }
                    }
                });

                Object.values(groups).forEach(g => {
                    if (g.statusWeight === 3) monthlyEarned += g.rate;
                    else if (g.statusWeight === 2) pendingPayment += g.rate;
                    else if (g.statusWeight === 1) monthlyProjected += g.rate;
                });

                return { monthlyEarned, monthlyProjected, pendingPayment };
            }, [data.projects, data.clients, currentDate]);

            // --- Views ---
            const columns = [
                { id: 'active', label: 'Animation Work', icon: Layers, color: 'text-blue-400' },
                { id: 'completed', label: 'Done (Pending Pay)', icon: CheckCircle, color: 'text-yellow-500' },
                { id: 'paid', label: 'Paid', icon: DollarSign, color: 'text-emerald-300' },
            ];

            const projectsByStatus = useMemo(() => {
                const grouped = { active: [], completed: [], paid: [] };
                let displayProjects = data.projects;
                if (filterByMonth && viewMode === 'board') {
                    displayProjects = data.projects.filter(p => {
                        const d = p.status === 'paid' ? p.paymentDate : p.deadline;
                        return isSameMonth(d, currentDate);
                    });
                }
                displayProjects.forEach(p => {
                    if (['completed'].includes(p.status)) grouped.completed.push(p);
                    else if (['paid'].includes(p.status)) grouped.paid.push(p);
                    else grouped.active.push(p);
                });
                return grouped;
            }, [data.projects, filterByMonth, currentDate, viewMode]);

            if (loading) return <div className="fixed inset-0 bg-gray-950 flex items-center justify-center text-white">Loading...</div>;

            return (
                <div className="fixed inset-0 bg-gray-950 text-gray-100 font-sans selection:bg-blue-500 selection:text-white flex flex-col overflow-hidden">
                    
                    {/* Header */}
                    <header className="bg-gray-900 border-b border-gray-800 sticky top-0 z-30 shadow-2xl shrink-0 h-14">
                        <div className="max-w-full mx-auto px-2 sm:px-4 h-full flex items-center justify-between gap-2">
                            <div className="flex items-center gap-2 sm:gap-4">
                                <div className="flex items-center space-x-2">
                                    <div className="w-8 h-8 bg-gradient-to-tr from-blue-600 to-purple-600 rounded-lg flex items-center justify-center shadow-lg"><Box className="text-white w-5 h-5" /></div>
                                    <h1 className="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400 hidden sm:block">AnimTrack</h1>
                                </div>
                                <div className="flex space-x-1 bg-gray-800 p-1 rounded-lg">
                                    <button onClick={() => setViewMode('board')} className={`px-2 sm:px-3 py-1 rounded-md text-xs font-medium transition ${viewMode === 'board' ? 'bg-gray-700 text-white shadow' : 'text-gray-400 hover:text-white'}`}><LayoutGrid size={14} /></button>
                                    <button onClick={() => setViewMode('calendar')} className={`px-2 sm:px-3 py-1 rounded-md text-xs font-medium transition ${viewMode === 'calendar' ? 'bg-gray-700 text-white shadow' : 'text-gray-400 hover:text-white'}`}><CalendarDays size={14} /></button>
                                    <button onClick={() => setViewMode('stats')} className={`px-2 sm:px-3 py-1 rounded-md text-xs font-medium transition ${viewMode === 'stats' ? 'bg-gray-700 text-white shadow' : 'text-gray-400 hover:text-white'}`}><BarChart2 size={14} /></button>
                                    <button onClick={() => setViewMode('leaves')} className={`px-2 sm:px-3 py-1 rounded-md text-xs font-medium transition ${viewMode === 'leaves' ? 'bg-gray-700 text-white shadow' : 'text-gray-400 hover:text-white'}`} title="Leave Tracker"><Umbrella size={14} /></button>
                                </div>
                            </div>
                            <div className="flex items-center space-x-2">
                                <button onClick={() => setShowRates(!showRates)} className="p-2 text-gray-400 bg-gray-800 border border-gray-700 rounded-lg hover:text-white" title={showRates ? "Hide Rates" : "Show Rates"}>
                                    {showRates ? <Eye size={16} /> : <EyeOff size={16} />}
                                </button>
                                <button onClick={() => setIsHolidayManagerOpen(true)} className="p-2 text-gray-400 bg-gray-800 border border-gray-700 rounded-lg hover:text-yellow-400" title="Holiday Manager">
                                    <Star size={16} />
                                </button>
                                <button onClick={() => setIsListManagerOpen(true)} className="p-2 text-gray-400 bg-gray-800 border border-gray-700 rounded-lg hover:text-white" title="Settings"><Settings size={16} /></button>
                                <button onClick={() => { setEditingProject(null); setIsModalOpen(true); }} className="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg text-xs font-medium flex items-center shadow-lg"><Plus size={14} className="mr-1" /> New</button>
                            </div>
                        </div>
                    </header>

                    {/* Sub-Header */}
                    {viewMode !== 'stats' && viewMode !== 'leaves' && (
                        <div className="flex flex-wrap items-center justify-between px-3 py-2 border-b border-gray-800 bg-gray-950/50 shrink-0 gap-2">
                            <div className="flex items-center bg-gray-800 rounded-lg p-0.5 border border-gray-700">
                                <button onClick={() => changeMonth(-1)} className="p-1 hover:bg-gray-700 rounded text-gray-400 hover:text-white"><ChevronLeft size={16}/></button>
                                <div className="flex items-center px-2 justify-center min-w-[100px]"><span className="text-xs font-bold text-gray-200">{currentDate.toLocaleString('default', { month: 'short', year: 'numeric' })}</span></div>
                                <button onClick={() => changeMonth(1)} className="p-1 hover:bg-gray-700 rounded text-gray-400 hover:text-white"><ChevronRight size={16}/></button>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setShowStats(!showStats)} className={`text-xs flex items-center px-3 py-1.5 rounded-lg border transition ${showStats ? 'bg-purple-600/20 border-purple-500 text-purple-300' : 'bg-gray-800 border-gray-700 text-gray-400'}`}><BarChart2 size={14} className="mr-1" /> Stats</button>
                                {viewMode === 'board' && <button onClick={() => setFilterByMonth(!filterByMonth)} className={`text-xs flex items-center px-3 py-1.5 rounded-lg border transition ${filterByMonth ? 'bg-blue-600/20 border-blue-500 text-blue-300' : 'bg-gray-800 border-gray-700 text-gray-400'}`}><Filter size={14} className="mr-1" /> {filterByMonth ? 'Month' : 'All'}</button>}
                            </div>
                        </div>
                    )}

                    {/* Stats */}
                    {showStats && viewMode !== 'stats' && viewMode !== 'leaves' && (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3 p-3 bg-gray-900 border-b border-gray-800 shrink-0">
                            <StatCard title="Projected" value={showRates ? `$${stats.monthlyProjected.toLocaleString()}` : '****'} icon={TrendingUp} colorClass="bg-blue-500 text-blue-500" />
                            <StatCard title="Earned" value={showRates ? `$${stats.monthlyEarned.toLocaleString()}` : '****'} icon={CreditCard} colorClass="bg-emerald-500 text-emerald-500" />
                            <StatCard title="Pending" value={showRates ? `$${stats.pendingPayment.toLocaleString()}` : '****'} icon={Clock} colorClass="bg-yellow-500 text-yellow-500" onClick={() => setIsPendingSummaryOpen(true)} />
                        </div>
                    )}

                    {/* Main Content */}
                    <main className="flex-1 overflow-hidden relative">
                        {viewMode === 'board' ? (
                            <div className="h-full overflow-y-auto custom-scrollbar p-4 space-y-6 pb-20">
                                {columns.map(col => (
                                    <div key={col.id} className="w-full">
                                        <div className="flex items-center mb-2 px-2 py-1.5 bg-gray-950/80 sticky top-0 z-10 backdrop-blur-sm border-b border-gray-800 rounded-t-lg">
                                            {col.id === 'paid' ? (
                                                 <button onClick={() => setIsArchiveOpen(true)} className="flex items-center w-full hover:bg-gray-800 rounded p-1 transition group">
                                                    <Folder size={18} className="mr-2 text-emerald-300 group-hover:text-emerald-200" />
                                                    <h3 className="font-bold text-gray-200 text-sm uppercase tracking-wide group-hover:text-white">Paid Projects Archive</h3>
                                                    <span className="ml-auto bg-gray-800 text-gray-500 text-[10px] px-2 py-0.5 rounded-full border border-gray-700">{projectsByStatus[col.id]?.length || 0}</span>
                                                </button>
                                            ) : (
                                                <>
                                                    <col.icon size={16} className={`mr-2 ${col.color}`} />
                                                    <h3 className="font-bold text-gray-200 text-sm uppercase tracking-wide">{col.label}</h3>
                                                    <span className="ml-auto bg-gray-800 text-gray-500 text-[10px] px-2 py-0.5 rounded-full border border-gray-700">{projectsByStatus[col.id]?.length || 0}</span>
                                                </>
                                            )}
                                        </div>
                                        
                                        {col.id !== 'paid' && (
                                            <div className="flex space-x-3 overflow-x-auto pb-4 px-1 custom-scrollbar min-h-[140px]">
                                                {projectsByStatus[col.id]?.map(p => (
                                                    <ProjectCard key={p.id} project={p} clients={data.clients} onEdit={() => {setEditingProject(p); setIsModalOpen(true);}} onViewDetails={() => setViewingProject(p)} moveStatus={handleMoveStatus} onToggleActive={handleToggleActive} showRates={showRates} />
                                                ))}
                                                {projectsByStatus[col.id]?.length === 0 && (
                                                    <div className="w-full h-32 flex items-center justify-center border-2 border-dashed border-gray-800/50 rounded-xl text-gray-600 text-xs italic shrink-0">
                                                        No Tasks in this Stage
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        ) : viewMode === 'calendar' ? (
                            <div className="h-full p-2">
                                <CalendarView projects={data.projects} holidays={data.holidays} currentDate={currentDate} onEdit={(p) => {setEditingProject(p); setIsModalOpen(true);}} />
                            </div>
                        ) : viewMode === 'stats' ? (
                            <div className="h-full p-4 overflow-y-auto">
                                <StatisticsView projects={data.projects} clients={data.clients} showRates={showRates} onOpenPending={() => setIsPendingSummaryOpen(true)} />
                            </div>
                        ) : viewMode === 'leaves' ? (
                            <div className="h-full p-4 overflow-y-auto">
                                <LeaveTrackerView leaves={data.leaves || []} totalLeaves={data.totalLeaves || 24} onAddLeave={handleAddLeave} onDeleteLeave={handleDeleteLeave} onUpdateTotalLeaves={(val) => setData(prev => ({...prev, totalLeaves: val}))} />
                            </div>
                        ) : null}
                    </main>

                    {/* Modals */}
                    <ProjectModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleSaveProject} onDelete={handleDeleteProject} initialData={editingProject} clients={data.clients} />
                    <ListManager isOpen={isListManagerOpen} onClose={() => setIsListManagerOpen(false)} onUpdateLists={handleUpdateLists} initialClients={data.clients} allData={data} onImport={handleImportData} />
                    <HolidayManager isOpen={isHolidayManagerOpen} onClose={() => setIsHolidayManagerOpen(false)} holidays={data.holidays} onUpdateHolidays={handleUpdateHolidays} />
                    <ArchiveModal isOpen={isArchiveOpen} onClose={() => setIsArchiveOpen(false)} projects={projectsByStatus.paid} clients={data.clients} onRestore={handleRestoreProject} showRates={showRates} />
                    <PendingSummaryModal isOpen={isPendingSummaryOpen} onClose={() => setIsPendingSummaryOpen(false)} projects={projectsByStatus.completed} clients={data.clients} showRates={showRates} onMarkPaid={handleBatchMarkPaid} />
                    {viewingProject && <ProjectDetails project={viewingProject} onClose={() => setViewingProject(null)} onUpdate={handleUpdateNotes} onEdit={() => {setViewingProject(null); setEditingProject(viewingProject); setIsModalOpen(true);}} />}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>