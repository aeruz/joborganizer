<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AnimTrack - Offline 3D Manager</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map for Modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #111827; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #4B5563; }
        
        /* Utility to hide scrollbars but keep functionality for touch/swiping */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Prevent bounce scroll on iOS */
        body { background-color: #030712; color: #f3f4f6; overflow: hidden; overscroll-behavior: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plus, DollarSign, Clock, CheckCircle, Film, Box, Calendar, Edit2, 
            Trash2, X, Save, TrendingUp, CreditCard, MonitorPlay, Briefcase, 
            ChevronLeft, ChevronRight, AlertCircle, Filter, AlignLeft, Settings, 
            Layers, ArrowRight, ShieldCheck, AlertTriangle, User, MoreHorizontal, 
            Download, Upload, FileJson, Sliders, WifiOff, LayoutGrid, CalendarDays,
            BarChart2, PenTool, Sparkles, Image as ImageIcon
        } from 'lucide-react';

        // --- Local Storage Helper ---
        const STORAGE_KEY = 'animtrack_db_v2'; 
        
        const loadData = () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) return JSON.parse(saved);
            return {
                projects: [],
                clients: [
                    { name: 'Example Studio', type: 'standard', salary: 0, payDay: 25 },
                    { name: 'Retainer Client', type: 'monthly', salary: 2500, payDay: 25 }
                ],
                projectList: ['Season 1', 'Commercial']
            };
        };

        const saveData = (data) => {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        };

        // --- Components ---

        const StatCard = ({ title, value, icon: Icon, colorClass, subtext }) => (
            <div className="bg-gray-800 border border-gray-700 p-3 sm:p-4 rounded-xl flex items-center space-x-3 shadow-lg hover:border-gray-600 transition-colors relative overflow-hidden group">
                <div className={`p-2 rounded-lg ${colorClass} bg-opacity-20`}>
                <Icon className={`w-4 h-4 sm:w-5 sm:h-5 ${colorClass.replace('bg-', 'text-')}`} />
                </div>
                <div className="z-10 min-w-0">
                <p className="text-gray-400 text-[10px] sm:text-xs font-medium truncate">{title}</p>
                <h3 className="text-lg sm:text-xl font-bold text-white truncate">{value}</h3>
                {subtext && <p className="text-[9px] sm:text-[10px] text-gray-500 mt-0.5 truncate">{subtext}</p>}
                </div>
                <Icon className={`absolute -right-4 -bottom-4 w-16 h-16 sm:w-20 sm:h-20 opacity-5 ${colorClass.replace('bg-', 'text-')} transform -rotate-12 group-hover:scale-110 transition-transform`} />
            </div>
        );

        const CalendarView = ({ projects, currentDate, onEdit }) => {
            const [dayProgress, setDayProgress] = useState(100);

            useEffect(() => {
                const updateDayProgress = () => {
                    const now = new Date();
                    const totalMinutes = 24 * 60;
                    const passedMinutes = now.getHours() * 60 + now.getMinutes();
                    setDayProgress(100 - ((passedMinutes / totalMinutes) * 100));
                };
                updateDayProgress();
                const interval = setInterval(updateDayProgress, 60000); 
                return () => clearInterval(interval);
            }, []);

            const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            
            const startDate = new Date(startOfMonth);
            startDate.setDate(startDate.getDate() - startDate.getDay());
            
            const endDate = new Date(endOfMonth);
            if (endDate.getDay() !== 6) {
                endDate.setDate(endDate.getDate() + (6 - endDate.getDay()));
            }

            const weeks = [];
            let currentWeek = [];
            let dayIter = new Date(startDate);

            while (dayIter <= endDate) {
                currentWeek.push(new Date(dayIter));
                if (currentWeek.length === 7) {
                    weeks.push(currentWeek);
                    currentWeek = [];
                }
                dayIter.setDate(dayIter.getDate() + 1);
            }

            const renderWeek = (weekDays) => {
                const weekStart = weekDays[0];
                const weekEnd = weekDays[6];
                weekEnd.setHours(23, 59, 59, 999); 

                const weekProjects = projects.filter(p => {
                    const pStart = p.startDate ? new Date(p.startDate) : (p.createdAt ? new Date(p.createdAt) : new Date());
                    const pEnd = p.deadline ? new Date(p.deadline) : new Date();
                    pStart.setHours(0,0,0,0);
                    pEnd.setHours(23,59,59,999);
                    return pStart <= weekEnd && pEnd >= weekStart;
                });

                weekProjects.sort((a,b) => {
                     const startA = a.startDate ? new Date(a.startDate) : new Date(a.createdAt);
                     const startB = b.startDate ? new Date(b.startDate) : new Date(b.createdAt);
                     return startA - startB;
                });

                const processedItems = weekProjects.map(p => {
                    const pStart = p.startDate ? new Date(p.startDate) : new Date(p.createdAt);
                    const pEnd = p.deadline ? new Date(p.deadline) : new Date();
                    pStart.setHours(0,0,0,0);
                    pEnd.setHours(23,59,59,999);

                    let startCol = 0;
                    let endCol = 6;
                    
                    if (pStart > weekStart) {
                        startCol = Math.floor((pStart - weekStart) / (1000 * 60 * 60 * 24));
                    }
                    if (pEnd < weekEnd) {
                        endCol = Math.floor((pEnd - weekStart) / (1000 * 60 * 60 * 24));
                    }
                    
                    const colSpan = (endCol - startCol) + 1;
                    return { ...p, startCol, colSpan };
                });

                const itemsWithLane = [];
                const grid = []; 

                processedItems.forEach(item => {
                    let lane = 0;
                    let placed = false;
                    while (!placed) {
                        if (!grid[lane]) grid[lane] = Array(7).fill(false);
                        let isClear = true;
                        for (let i = item.startCol; i < item.startCol + item.colSpan; i++) {
                            if (grid[lane][i]) {
                                isClear = false;
                                break;
                            }
                        }
                        if (isClear) {
                            for (let i = item.startCol; i < item.startCol + item.colSpan; i++) {
                                grid[lane][i] = true;
                            }
                            itemsWithLane.push({ ...item, lane });
                            placed = true;
                        } else {
                            lane++;
                        }
                    }
                });

                return { weekDays, items: itemsWithLane, gridHeight: grid.length };
            };

            const renderedWeeks = weeks.map(renderWeek);

            const getStatusColor = (status) => {
                switch(status) {
                    case 'paid': return 'bg-emerald-500 border-emerald-600 text-emerald-100';
                    case 'completed': return 'bg-yellow-500 border-yellow-600 text-yellow-900';
                    default: return 'bg-blue-500 border-blue-500 text-white';
                }
            };

            return (
                <div className="bg-gray-900 border border-gray-800 rounded-xl shadow-xl overflow-hidden flex flex-col h-full">
                    {/* Overflow-x-auto wrapper for very narrow split views */}
                    <div className="flex-1 overflow-auto custom-scrollbar bg-gray-900">
                        <div className="min-w-[320px]">
                            <div className="grid grid-cols-7 border-b border-gray-800 bg-gray-950/50 sticky top-0 z-20">
                                {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (
                                    <div key={d} className="text-gray-500 text-[10px] uppercase font-bold text-center py-2">{d}</div>
                                ))}
                            </div>
                            
                            {renderedWeeks.map((weekData, wIdx) => (
                                <div key={wIdx} className="relative border-b border-gray-800 min-h-[80px] md:min-h-[100px]">
                                    <div className="grid grid-cols-7 absolute inset-0 z-0">
                                        {weekData.weekDays.map((day, dIdx) => {
                                            const now = new Date();
                                            const isToday = day.toDateString() === now.toDateString();
                                            const isPast = day < new Date(now.setHours(0,0,0,0));
                                            
                                            return (
                                                <div key={dIdx} className={`relative border-r border-gray-800/50 p-1 overflow-hidden ${isPast ? 'bg-gray-950/80' : ''} ${isToday ? 'bg-gray-800 shadow-inner' : ''}`}>
                                                    {isToday && (
                                                        <div 
                                                            className="absolute bottom-0 left-0 right-0 bg-blue-500/10 z-0 transition-all duration-1000"
                                                            style={{ height: `${dayProgress}%` }} 
                                                        />
                                                    )}
                                                    
                                                    <div className={`relative z-10 text-[10px] md:text-xs font-bold flex justify-center items-center w-6 h-6 rounded-full ${isToday ? 'bg-blue-500 text-white shadow-lg shadow-blue-500/50 scale-110' : isPast ? 'text-gray-600' : 'text-gray-400'}`}>
                                                        {day.getDate()}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>

                                    <div className="relative z-10 mt-8 pb-2 w-full" style={{ height: `${Math.max(weekData.gridHeight * 26, 20)}px` }}> 
                                        {weekData.items.map(item => (
                                            <button
                                                key={item.id}
                                                onClick={() => onEdit(item)}
                                                className={`absolute h-5 rounded text-[9px] md:text-[10px] px-1 md:px-2 text-left truncate shadow-sm border-l-2 hover:brightness-110 transition-all ${getStatusColor(item.status)}`}
                                                style={{
                                                    left: `${(item.startCol / 7) * 100 + 0.5}%`,
                                                    width: `${(item.colSpan / 7) * 100 - 1}%`,
                                                    top: `${item.lane * 26}px`
                                                }}
                                                title={`${item.name}`}
                                            >
                                                {item.name}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const ProjectCard = ({ project, onEdit, onViewDetails, moveStatus }) => {
            const isShot = project.payType === 'shot' || project.payType === 'retainer_work';
            const isRetainer = project.payType === 'retainer_work';
            const val = isShot ? (project.shotRate * project.shotCount) : project.fixedPrice;
            
            const today = new Date();
            const deadline = project.deadline ? new Date(project.deadline) : null;
            
            let daysLeft = null, isOverdue = false, border = 'border-gray-700';
            if(deadline && project.status!=='paid' && project.status!=='completed'){
                const diff = deadline - today;
                daysLeft = Math.ceil(diff/(1000*60*60*24));
                if(daysLeft < 0) isOverdue=true;
            }

            // Stage Visuals (Color & Badge)
            let stageColor = 'text-gray-400 border-gray-600';
            let StageIcon = Box;
            
            if (['inquiry','layout','blocking','splining','polishing'].includes(project.status)) {
                switch(project.status) {
                    case 'layout': 
                        stageColor = 'text-blue-400 border-blue-500/50 bg-blue-900/10'; 
                        StageIcon = Layers;
                        break;
                    case 'blocking': 
                        stageColor = 'text-indigo-400 border-indigo-500/50 bg-indigo-900/10'; 
                        StageIcon = Box;
                        break;
                    case 'splining': 
                        stageColor = 'text-purple-400 border-purple-500/50 bg-purple-900/10'; 
                        StageIcon = PenTool;
                        break;
                    case 'polishing': 
                        stageColor = 'text-pink-400 border-pink-500/50 bg-pink-900/10'; 
                        StageIcon = Sparkles;
                        break;
                    default: // inquiry
                        stageColor = 'text-gray-400 border-gray-600 bg-gray-800'; 
                }
            } else if (project.status === 'completed') {
                stageColor = 'text-yellow-400 border-yellow-500/50 bg-yellow-900/10';
            } else if (project.status === 'paid') {
                stageColor = 'text-emerald-400 border-emerald-500/50 bg-emerald-900/10';
            }

            return (
                <div onClick={() => onViewDetails(project)} className={`bg-gray-800 rounded-xl p-3 mb-2 shadow-md active:scale-95 transition-transform group relative border-l-4 ${isOverdue ? 'border-red-500' : 'border-gray-700'}`}>
                    <div className="flex justify-between items-start mb-2">
                        <div className="flex-1 pr-2 overflow-hidden">
                            <div className="flex items-center text-[10px] text-gray-500 font-semibold mb-0.5 truncate uppercase tracking-wider">
                                {project.client}
                            </div>
                            <h4 className="font-bold text-sm text-white truncate">{project.name}</h4>
                        </div>
                        <button onClick={(e) => { e.stopPropagation(); onEdit(project); }} className="text-gray-500 hover:text-white p-1 hover:bg-gray-700 rounded"><Edit2 size={14} /></button>
                    </div>

                    <div className="flex items-center justify-between mb-2">
                        <div className={`flex items-center px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide border ${stageColor}`}>
                            <StageIcon size={10} className="mr-1.5" />
                            {project.status === 'completed' ? 'Done' : project.status}
                        </div>
                        <span className={`text-xs font-mono font-bold ${isRetainer?'text-purple-400':'text-emerald-400'}`}>
                            {isRetainer && val > 0 ? '(Cvrd)' : `$${val.toLocaleString()}`}
                        </span>
                    </div>
                    
                    <div className="space-y-1">
                        <div className="w-full bg-gray-700 rounded-full h-1 overflow-hidden">
                            <div className="bg-blue-500 h-1 rounded-full" style={{width: `${project.progress||0}%`}}></div>
                        </div>
                        {deadline && (
                            <div className="flex justify-between items-center pt-1">
                                <span className={`text-[10px] flex items-center ${isOverdue ? 'text-red-400 font-bold' : 'text-gray-500'}`}>
                                    <Clock size={10} className="mr-1"/> 
                                    {isOverdue ? 'Overdue' : deadline.toLocaleDateString(undefined, {month:'short', day:'numeric'})}
                                </span>
                            </div>
                        )}
                    </div>

                    {project.status !== 'paid' && (
                        <div className="mt-2 pt-2 border-t border-gray-700/50 flex justify-end">
                            <button onClick={(e) => { e.stopPropagation(); moveStatus(project, 'forward'); }} className="text-[10px] bg-gray-700 hover:bg-gray-600 text-white px-2 py-1 rounded flex items-center shadow-sm border border-gray-600">
                                Next Stage <ArrowRight size={10} className="ml-1"/>
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        const ProjectDetails = ({ project, onClose, onUpdate, onEdit }) => {
            const [notes, setNotes] = useState(project.notes || '');
            const [progress, setProgress] = useState(project.progress || 0);
            const [isSaving, setIsSaving] = useState(false);
            const timer = useRef(null);

            const save = (n, p) => {
                setIsSaving(true);
                onUpdate(project.id, { notes: n, progress: p });
                setTimeout(()=>setIsSaving(false), 500);
            };

            const changeNotes = (e) => { setNotes(e.target.value); clearTimeout(timer.current); timer.current = setTimeout(() => save(e.target.value, progress), 1000); };
            const changeProg = (e) => { setProgress(e.target.value); clearTimeout(timer.current); timer.current = setTimeout(() => save(notes, e.target.value), 500); };

            return (
                <div className="fixed inset-0 z-50 flex justify-end">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />
                    <div className="relative w-full max-w-2xl bg-gray-900 h-full border-l border-gray-800 shadow-2xl flex flex-col">
                        <div className="p-4 md:p-6 border-b border-gray-800 bg-gray-900 z-10 flex justify-between items-start">
                            <div>
                                <h2 className="text-xl md:text-2xl font-bold text-white">{project.name}</h2>
                                <p className="text-gray-400 text-sm">{project.client} / {project.projectName}</p>
                            </div>
                            <div className="flex space-x-2">
                                <button onClick={onEdit} className="p-2 hover:bg-gray-800 rounded text-gray-400"><Edit2 size={18}/></button>
                                <button onClick={onClose} className="p-2 hover:bg-gray-800 rounded text-gray-400"><X size={18}/></button>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 md:p-6 custom-scrollbar">
                            <div className="mb-6 bg-gray-800 p-4 rounded-xl border border-gray-700">
                                <div className="flex justify-between mb-2 text-sm font-bold text-gray-300"><span>Progress</span><span className="text-blue-400">{progress}%</span></div>
                                <input type="range" min="0" max="100" value={progress} onChange={changeProg} className="w-full h-2 bg-gray-700 rounded-lg accent-blue-500" />
                            </div>
                            <div className="flex flex-col h-[calc(100%-150px)]">
                                <div className="flex justify-between mb-3 text-sm font-bold text-gray-300">
                                    <span>Notes</span>
                                    {isSaving && <span className="text-blue-400 animate-pulse text-xs">Saving...</span>}
                                </div>
                                <textarea className="w-full h-full bg-gray-950 border border-gray-800 rounded-xl p-4 md:p-6 text-gray-300 outline-none resize-none font-mono text-sm shadow-inner" value={notes} onChange={changeNotes} placeholder="Type notes..." />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ListManager = ({ isOpen, onClose, onUpdateLists, initialClients, initialProjects, allData, onImport }) => {
            const [activeTab, setActiveTab] = useState('clients');
            const [clients, setClients] = useState(initialClients);
            const [projects, setProjects] = useState(initialProjects);
            const [clientForm, setClientForm] = useState({ name: '', type: 'standard', salary: 0, payDay: 25 });
            const [projInput, setProjInput] = useState('');
            const fileRef = useRef(null);

            useEffect(() => { setClients(initialClients); setProjects(initialProjects); }, [initialClients, initialProjects, isOpen]);
            if(!isOpen) return null;

            const saveClient = () => {
                if(!clientForm.name) return;
                const newClients = [...clients, clientForm];
                setClients(newClients);
                onUpdateLists(newClients, projects);
                setClientForm({ name: '', type: 'standard', salary: 0, payDay: 25 });
            };
            const deleteClient = (idx) => {
                if(confirm('Delete?')) {
                    const n = clients.filter((_,i)=>i!==idx);
                    setClients(n);
                    onUpdateLists(n, projects);
                }
            }
            const exportData = () => {
                const blob = new Blob([JSON.stringify(allData,null,2)], {type : 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `animtrack_backup_${new Date().toISOString().split('T')[0]}.json`; a.click();
            };
            const importData = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const r = new FileReader();
                r.onload = (ev) => {
                    try {
                        const d = JSON.parse(ev.target.result);
                        if(onImport(d)) {
                            alert('Imported successfully! Updating view...');
                            onClose();
                        } else alert('Invalid file format.');
                    } catch(err) { alert('Error parsing JSON'); }
                };
                r.readAsText(file);
            }

            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div className="bg-gray-900 border border-gray-700 w-full max-w-2xl rounded-2xl h-[600px] flex flex-col">
                        <div className="flex border-b border-gray-800">
                            <button onClick={()=>setActiveTab('clients')} className={`flex-1 py-3 text-sm font-bold ${activeTab==='clients'?'bg-gray-800 text-white border-b-2 border-blue-500':'text-gray-400'}`}>Clients</button>
                            <button onClick={()=>setActiveTab('projects')} className={`flex-1 py-3 text-sm font-bold ${activeTab==='projects'?'bg-gray-800 text-white border-b-2 border-purple-500':'text-gray-400'}`}>Projects</button>
                            <button onClick={()=>setActiveTab('data')} className={`flex-1 py-3 text-sm font-bold ${activeTab==='data'?'bg-gray-800 text-white border-b-2 border-emerald-500':'text-gray-400'}`}>Data</button>
                            <button onClick={onClose} className="px-4 text-gray-400 hover:text-white"><X/></button>
                        </div>
                        <div className="p-4 sm:p-6 flex-1 overflow-y-auto custom-scrollbar">
                            {activeTab==='clients' && (
                                <div className="flex flex-col sm:flex-row h-full gap-6">
                                    <div className="w-full sm:w-1/3 sm:border-r border-gray-800 sm:pr-4 space-y-2">
                                        {clients.map((c,i)=>(
                                            <div key={i} className="bg-gray-800 p-2 rounded flex justify-between items-center">
                                                <div><p className="text-sm">{c.name}</p><p className="text-[10px] text-gray-500 uppercase">{c.type}</p></div>
                                                <button onClick={()=>deleteClient(i)} className="text-gray-500 hover:text-red-400"><Trash2 size={12}/></button>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="w-full sm:w-2/3 space-y-4">
                                        <input className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm text-white" placeholder="Client Name" value={clientForm.name} onChange={e=>setClientForm({...clientForm, name:e.target.value})} />
                                        <div className="flex gap-2">
                                            <button onClick={()=>setClientForm({...clientForm, type:'standard'})} className={`flex-1 py-2 text-xs border rounded ${clientForm.type==='standard'?'bg-blue-600 border-blue-500':'border-gray-700'}`}>Standard</button>
                                            <button onClick={()=>setClientForm({...clientForm, type:'monthly'})} className={`flex-1 py-2 text-xs border rounded ${clientForm.type==='monthly'?'bg-purple-600 border-purple-500':'border-gray-700'}`}>Retainer</button>
                                        </div>
                                        {clientForm.type==='monthly' && (
                                            <div className="space-y-2 bg-gray-800/50 p-2 rounded">
                                                <input type="number" placeholder="Salary" className="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm text-white" value={clientForm.salary} onChange={e=>setClientForm({...clientForm, salary:e.target.value})} />
                                                <input type="number" placeholder="Pay Day (e.g. 25)" className="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm text-white" value={clientForm.payDay} onChange={e=>setClientForm({...clientForm, payDay:e.target.value})} />
                                            </div>
                                        )}
                                        <button onClick={saveClient} className="w-full bg-emerald-600 hover:bg-emerald-500 py-2 rounded text-sm font-bold">Add Client</button>
                                    </div>
                                </div>
                            )}
                            {activeTab==='projects' && (
                                <div>
                                    <div className="flex gap-2 mb-4">
                                        <input className="flex-1 bg-gray-800 border border-gray-700 rounded p-2 text-sm text-white" placeholder="New Project Name" value={projInput} onChange={e=>setProjInput(e.target.value)} />
                                        <button onClick={()=>{if(projInput){const n=[...projects, projInput]; setProjects(n); onUpdateLists(clients, n); setProjInput('');}}} className="bg-blue-600 px-4 rounded"><Plus/></button>
                                    </div>
                                    <div className="space-y-2">
                                        {projects.map((p,i)=>(
                                            <div key={i} className="bg-gray-800 p-2 rounded flex justify-between">
                                                <span>{p}</span>
                                                <button onClick={()=>{const n=projects.filter((_,idx)=>idx!==i); setProjects(n); onUpdateLists(clients,n);}}><Trash2 size={14}/></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            {activeTab==='data' && (
                                <div className="flex flex-col items-center justify-center h-full space-y-4">
                                    <button onClick={exportData} className="flex flex-col items-center p-6 bg-gray-800 border border-gray-700 rounded-xl hover:border-emerald-500"><Download className="mb-2 text-emerald-500"/> Export JSON</button>
                                    <button onClick={()=>fileRef.current.click()} className="flex flex-col items-center p-6 bg-gray-800 border border-gray-700 rounded-xl hover:border-blue-500"><Upload className="mb-2 text-blue-500"/> Import JSON</button>
                                    <input type="file" ref={fileRef} className="hidden" accept=".json" onChange={importData} />
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const ProjectModal = ({ isOpen, onClose, onSave, onDelete, initialData, clients, projects }) => {
            const [form, setForm] = useState({ name: '', client: '', projectName: '', payType: 'fixed', status: 'inquiry', fixedPrice: 0, shotRate: 0, shotCount: 1, startDate: '', deadline: '', paymentDate: '', notes: '', progress: 0 });
            const [del, setDel] = useState(false);
            const [clientConf, setClientConf] = useState(null);

            useEffect(() => {
                if(isOpen) {
                    if(initialData) {
                        setForm({...initialData, startDate: initialData.startDate || (initialData.createdAt ? initialData.createdAt.split('T')[0] : ''), paymentDate:initialData.paymentDate||''});
                        setClientConf(clients.find(c=>c.name===initialData.client));
                    } else {
                        const defC = clients[0];
                        const today = new Date().toISOString().split('T')[0];
                        setForm({ name: '', client: defC?.name||'', projectName: projects[0]||'', payType: defC?.type==='monthly'?'retainer_work':'fixed', status: 'inquiry', fixedPrice: 0, shotRate: 0, shotCount: 1, startDate: today, deadline: '', paymentDate: '', notes: '', progress: 0 });
                        setClientConf(defC);
                    }
                    setDel(false);
                }
            }, [isOpen, initialData, clients, projects]);

            const changeClient = (e) => {
                const n = e.target.value;
                const c = clients.find(cl=>cl.name===n);
                setClientConf(c);
                setForm({...form, client: n, payType: c?.type==='monthly'?'retainer_work':'fixed', fixedPrice: 0});
            };

            const setRetainerMode = (mode) => {
                if(mode==='payment') {
                    const d = new Date(); d.setDate(clientConf?.payDay||25);
                    setForm({...form, payType:'retainer_salary', name:`${d.toLocaleString('default',{month:'long'})} Salary`, fixedPrice: parseFloat(clientConf?.salary)||0, deadline: d.toISOString().split('T')[0]});
                } else {
                    setForm({...form, payType:'retainer_work', name:'', fixedPrice:0, deadline:''});
                }
            };

            if(!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                    <div className="bg-gray-900 border border-gray-700 w-full max-w-lg rounded-2xl p-4 sm:p-6 shadow-2xl flex flex-col max-h-[90vh] overflow-y-auto custom-scrollbar">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-white">{initialData?'Edit':'New'} Task</h2>
                            <button onClick={onClose}><X/></button>
                        </div>
                        <div className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs text-gray-400">Client</label>
                                    <select className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white" value={form.client} onChange={changeClient}>
                                        {clients.map(c=><option key={c.name} value={c.name}>{c.name}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs text-gray-400">Project</label>
                                    <select className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white" value={form.projectName} onChange={e=>setForm({...form, projectName:e.target.value})}>
                                        <option value="">Select...</option>
                                        {projects.map(p=><option key={p} value={p}>{p}</option>)}
                                    </select>
                                </div>
                            </div>

                            <div className="bg-gray-800/50 p-4 rounded-xl border border-gray-700">
                                {clientConf?.type === 'monthly' ? (
                                    <div className="space-y-4">
                                        <div className="flex gap-2">
                                            <button onClick={()=>setRetainerMode('work')} className={`flex-1 py-2 text-xs rounded border ${form.payType==='retainer_work'?'bg-purple-600 border-purple-500':'border-gray-700'}`}>Log Work</button>
                                            <button onClick={()=>setRetainerMode('payment')} className={`flex-1 py-2 text-xs rounded border ${form.payType==='retainer_salary'?'bg-emerald-600 border-emerald-500':'border-gray-700'}`}>Log Salary</button>
                                        </div>
                                        {form.payType === 'retainer_work' ? (
                                            <div className="grid grid-cols-2 gap-4">
                                                <input type="number" placeholder="Rate" className="bg-gray-900 border border-gray-700 rounded p-2 text-white" value={form.shotRate} onChange={e=>setForm({...form, shotRate:e.target.value})} />
                                                <input type="number" placeholder="Count" className="bg-gray-900 border border-gray-700 rounded p-2 text-white" value={form.shotCount} onChange={e=>setForm({...form, shotCount:e.target.value})} />
                                            </div>
                                        ) : (
                                            <div className="text-center text-emerald-400 font-bold text-lg">${form.fixedPrice}</div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        <div className="flex gap-2">
                                            <button onClick={()=>setForm({...form, payType:'fixed'})} className={`flex-1 py-2 text-xs rounded border ${form.payType==='fixed'?'bg-blue-600 border-blue-500':'border-gray-700'}`}>Fixed</button>
                                            <button onClick={()=>setForm({...form, payType:'shot'})} className={`flex-1 py-2 text-xs rounded border ${form.payType==='shot'?'bg-blue-600 border-blue-500':'border-gray-700'}`}>Shot</button>
                                        </div>
                                        {form.payType==='shot' ? (
                                            <div className="grid grid-cols-2 gap-4">
                                                <input type="number" placeholder="Rate" className="bg-gray-900 border border-gray-700 rounded p-2 text-white" value={form.shotRate} onChange={e=>setForm({...form, shotRate:e.target.value})} />
                                                <input type="number" placeholder="Count" className="bg-gray-900 border border-gray-700 rounded p-2 text-white" value={form.shotCount} onChange={e=>setForm({...form, shotCount:e.target.value})} />
                                            </div>
                                        ) : <input type="number" placeholder="Amount" className="w-full bg-gray-900 border border-gray-700 rounded p-2 text-white" value={form.fixedPrice} onChange={e=>setForm({...form, fixedPrice:e.target.value})} />}
                                    </div>
                                )}
                            </div>

                            <input type="text" placeholder="Task Name" className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} />
                            
                            <div className="grid grid-cols-3 gap-4">
                                <div className="col-span-1">
                                    <label className="text-[10px] text-gray-500 uppercase font-bold mb-1 block">Start Date</label>
                                    <input type="date" className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-xs" value={form.startDate} onChange={e=>setForm({...form, startDate:e.target.value})} />
                                </div>
                                <div className="col-span-1">
                                    <label className="text-[10px] text-gray-500 uppercase font-bold mb-1 block">{form.status==='paid'?'Paid Date':'Deadline'}</label>
                                    <input type="date" className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-xs" value={form.status==='paid'?form.paymentDate:form.deadline} onChange={e=>form.status==='paid'?setForm({...form, paymentDate:e.target.value}):setForm({...form, deadline:e.target.value})} />
                                </div>
                                <div className="col-span-1">
                                    <label className="text-[10px] text-gray-500 uppercase font-bold mb-1 block">Stage</label>
                                    <select className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white text-xs" value={form.status} onChange={e=>setForm({...form, status:e.target.value})}>
                                        <optgroup label="Animation Work">
                                            <option value="inquiry">Inquiry</option>
                                            <option value="layout">Layout</option>
                                            <option value="blocking">Blocking</option>
                                            <option value="splining">Splining</option>
                                            <option value="polishing">Polish</option>
                                        </optgroup>
                                        <optgroup label="Finished">
                                            <option value="completed">Done (Pending Pay)</option>
                                            <option value="paid">Paid</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>

                            <div className="flex justify-between pt-4 border-t border-gray-800">
                                {initialData ? <button onClick={()=>{if(del){onDelete(initialData.id); onClose();}else setDel(true)}} className={`text-sm px-3 py-2 rounded ${del?'bg-red-600 text-white':'text-red-400 hover:bg-gray-800'}`}>{del?'Confirm':'Delete'}</button> : <div></div>}
                                <div className="flex gap-2">
                                    <button onClick={onClose} className="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                                    <button onClick={()=>{onSave(form)}} className="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold">Save</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main Application ---
        function App() {
            // State
            const [data, setData] = useState({ projects: [], clients: [], projectList: [] });
            const [loading, setLoading] = useState(true);
            
            // UI State
            const [viewMode, setViewMode] = useState('board'); 
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isListManagerOpen, setIsListManagerOpen] = useState(false);
            const [editingProject, setEditingProject] = useState(null);
            const [viewingProject, setViewingProject] = useState(null);
            const [currentDate, setCurrentDate] = useState(new Date());
            const [filterByMonth, setFilterByMonth] = useState(false);
            const [showStats, setShowStats] = useState(false); 

            // Load Data on Mount
            useEffect(() => {
                const loaded = loadData();
                setData(loaded);
                setLoading(false);
            }, []);

            // Save Data Effect (whenever data changes)
            useEffect(() => {
                if (!loading) {
                    saveData(data);
                }
            }, [data, loading]);

            // --- Handlers ---

            const handleUpdateLists = (newClients, newProjectList) => {
                setData(prev => ({ ...prev, clients: newClients, projectList: newProjectList }));
            };

            const handleSaveProject = (formProject) => {
                const now = new Date().toISOString();
                let updatedProjects;

                if (editingProject) {
                    updatedProjects = data.projects.map(p => 
                        p.id === editingProject.id 
                        ? { ...p, ...formProject, updatedAt: now } 
                        : p
                    );
                } else {
                    const newProject = {
                        ...formProject,
                        id: crypto.randomUUID(), 
                        createdAt: now,
                        updatedAt: now
                    };
                    updatedProjects = [...data.projects, newProject];
                }
                
                setData(prev => ({ ...prev, projects: updatedProjects }));
                setIsModalOpen(false);
                setEditingProject(null);
            };

            const handleDeleteProject = (id) => {
                setData(prev => ({ ...prev, projects: prev.projects.filter(p => p.id !== id) }));
                if (viewingProject?.id === id) setViewingProject(null);
            };

            const handleUpdateNotes = (projectId, updates) => {
                setData(prev => ({
                    ...prev,
                    projects: prev.projects.map(p => p.id === projectId ? { ...p, ...updates } : p)
                }));
                if (viewingProject?.id === projectId) {
                    setViewingProject(prev => ({ ...prev, ...updates }));
                }
            };

            const handleMoveStatus = (project, direction) => {
                // Simplified Workflow Order
                const flow = ['inquiry', 'layout', 'blocking', 'splining', 'polishing', 'completed', 'paid'];
                const currentIndex = flow.indexOf(project.status);
                let newIndex = currentIndex;
                if (direction === 'forward' && currentIndex < flow.length - 1) newIndex++;
                if (direction === 'back' && currentIndex > 0) newIndex--;

                if (newIndex !== currentIndex) {
                    const newStatus = flow[newIndex];
                    const todayStr = new Date().toISOString().split('T')[0];
                    let updates = { status: newStatus };
                    if (newStatus === 'paid' && !project.paymentDate) updates.paymentDate = todayStr;

                    const isRetainer = project.payType.includes('retainer') || project.payType === 'monthly';
                    
                    if (newStatus === 'paid' && isRetainer) {
                        const updatedProjects = data.projects.map(p => {
                            if (p.id === project.id) return { ...p, ...updates };
                            if (p.client === project.client && p.status === 'completed') {
                                return { ...p, status: 'paid', paymentDate: p.paymentDate || todayStr };
                            }
                            return p;
                        });
                        setData(prev => ({ ...prev, projects: updatedProjects }));
                    } else {
                        const updatedProjects = data.projects.map(p => 
                            p.id === project.id ? { ...p, ...updates } : p
                        );
                        setData(prev => ({ ...prev, projects: updatedProjects }));
                    }
                }
            };

            const handleImportData = (importedData) => {
                if (importedData.projects && importedData.clients) {
                    setData({
                        projects: importedData.projects || [],
                        clients: importedData.clients || [],
                        projectList: importedData.projectList || importedData.settings?.projects || [] 
                    });
                    return true;
                }
                return false;
            };

            // --- Stats Calculation ---
            const changeMonth = (dir) => {
                const d = new Date(currentDate);
                d.setMonth(currentDate.getMonth() + dir);
                setCurrentDate(d);
            };

            const isSameMonth = (dStr, target) => {
                if (!dStr) return false;
                const d = new Date(dStr);
                return d.getMonth() === target.getMonth() && d.getFullYear() === target.getFullYear();
            };

            const stats = useMemo(() => {
                let monthlyEarned = 0, monthlyProjected = 0, pendingPayment = 0;
                data.projects.forEach(p => {
                    let val = 0;
                    if (p.payType === 'shot') val = (parseFloat(p.shotRate||0) * parseInt(p.shotCount||0));
                    else if (p.payType === 'fixed' || p.payType === 'retainer_salary') val = parseFloat(p.fixedPrice||0);
                    
                    if (p.status === 'paid') {
                        if (isSameMonth(p.paymentDate, currentDate)) monthlyEarned += val;
                    } else if (['layout', 'blocking', 'splining', 'polishing', 'completed', 'inquiry'].includes(p.status)) {
                        if (p.deadline && isSameMonth(p.deadline, currentDate)) monthlyProjected += val;
                        if (p.status === 'completed') pendingPayment += val;
                    }
                });
                return { monthlyEarned, monthlyProjected, pendingPayment };
            }, [data.projects, currentDate]);

            // --- Views ---
            // Simplified 3-Column Board
            const columns = [
                { id: 'active', label: 'Animation Work', icon: Layers, color: 'text-blue-400' },
                { id: 'completed', label: 'Done (Pending Pay)', icon: CheckCircle, color: 'text-yellow-500' },
                { id: 'paid', label: 'Paid', icon: DollarSign, color: 'text-emerald-300' },
            ];

            const projectsByStatus = useMemo(() => {
                const grouped = { active: [], completed: [], paid: [] };
                
                let displayProjects = data.projects;
                if (filterByMonth && viewMode === 'board') {
                    displayProjects = data.projects.filter(p => {
                        const d = p.status === 'paid' ? p.paymentDate : p.deadline;
                        return isSameMonth(d, currentDate);
                    });
                }

                displayProjects.forEach(p => {
                    if (['completed'].includes(p.status)) {
                        grouped.completed.push(p);
                    } else if (['paid'].includes(p.status)) {
                        grouped.paid.push(p);
                    } else {
                        // Everything else (inquiry, layout, blocking, splining, polishing) goes to active
                        grouped.active.push(p);
                    }
                });

                Object.keys(grouped).forEach(k => grouped[k].sort((a,b) => {
                    if(!a.deadline) return 1; if(!b.deadline) return -1;
                    return new Date(a.deadline) - new Date(b.deadline);
                }));
                return grouped;
            }, [data.projects, filterByMonth, currentDate, viewMode]);

            if (loading) return <div className="fixed inset-0 bg-gray-950 flex items-center justify-center text-white">Loading...</div>;

            return (
                <div className="fixed inset-0 bg-gray-950 text-gray-100 font-sans selection:bg-blue-500 selection:text-white flex flex-col overflow-hidden">
                    
                    {/* Compact Header */}
                    <header className="bg-gray-900 border-b border-gray-800 sticky top-0 z-30 shadow-2xl shrink-0 h-14">
                        <div className="max-w-full mx-auto px-2 sm:px-4 h-full flex items-center justify-between gap-2">
                            {/* Left: Logo & View Tabs */}
                            <div className="flex items-center gap-2 sm:gap-4">
                                <div className="flex items-center space-x-2">
                                    <div className="w-8 h-8 bg-gradient-to-tr from-blue-600 to-purple-600 rounded-lg flex items-center justify-center shadow-lg">
                                        <Box className="text-white w-5 h-5" />
                                    </div>
                                    <h1 className="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400 hidden sm:block">AnimTrack</h1>
                                </div>
                                <div className="flex space-x-1 bg-gray-800 p-1 rounded-lg">
                                    <button 
                                        onClick={() => setViewMode('board')}
                                        className={`px-2 sm:px-3 py-1 rounded-md text-xs font-medium transition ${viewMode === 'board' ? 'bg-gray-700 text-white shadow' : 'text-gray-400 hover:text-white'}`}
                                    >
                                        <LayoutGrid size={14} />
                                    </button>
                                    <button 
                                        onClick={() => setViewMode('calendar')}
                                        className={`px-2 sm:px-3 py-1 rounded-md text-xs font-medium transition ${viewMode === 'calendar' ? 'bg-gray-700 text-white shadow' : 'text-gray-400 hover:text-white'}`}
                                    >
                                        <CalendarDays size={14} />
                                    </button>
                                </div>
                            </div>

                            {/* Right: Actions */}
                            <div className="flex items-center space-x-2">
                                <button onClick={() => setIsListManagerOpen(true)} className="p-2 text-gray-400 bg-gray-800 border border-gray-700 rounded-lg hover:text-white"><Settings size={16} /></button>
                                <button onClick={() => { setEditingProject(null); setIsModalOpen(true); }} className="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg text-xs font-medium flex items-center shadow-lg"><Plus size={14} className="mr-1" /> New</button>
                            </div>
                        </div>
                    </header>

                    {/* Sub-Header (Controls) */}
                    <div className="flex flex-wrap items-center justify-between px-3 py-2 border-b border-gray-800 bg-gray-950/50 shrink-0 gap-2">
                        {/* Date Nav */}
                        <div className="flex items-center bg-gray-800 rounded-lg p-0.5 border border-gray-700">
                            <button onClick={() => changeMonth(-1)} className="p-1 hover:bg-gray-700 rounded text-gray-400 hover:text-white"><ChevronLeft size={16}/></button>
                            <div className="flex items-center px-2 justify-center min-w-[100px]">
                                <span className="text-xs font-bold text-gray-200">{currentDate.toLocaleString('default', { month: 'short', year: 'numeric' })}</span>
                            </div>
                            <button onClick={() => changeMonth(1)} className="p-1 hover:bg-gray-700 rounded text-gray-400 hover:text-white"><ChevronRight size={16}/></button>
                        </div>

                        {/* Right: Filter & Stats Toggle */}
                        <div className="flex items-center gap-2">
                            <button 
                                onClick={() => setShowStats(!showStats)} 
                                className={`text-xs flex items-center px-3 py-1.5 rounded-lg border transition ${showStats ? 'bg-purple-600/20 border-purple-500 text-purple-300' : 'bg-gray-800 border-gray-700 text-gray-400'}`}
                            >
                                <BarChart2 size={14} className="mr-1" /> Stats
                            </button>
                            {viewMode === 'board' && (
                                <button onClick={() => setFilterByMonth(!filterByMonth)} className={`text-xs flex items-center px-3 py-1.5 rounded-lg border transition ${filterByMonth ? 'bg-blue-600/20 border-blue-500 text-blue-300' : 'bg-gray-800 border-gray-700 text-gray-400'}`}>
                                    <Filter size={14} className="mr-1" /> {filterByMonth ? 'Month' : 'All'}
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Stats Panel (Collapsible) */}
                    {showStats && (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3 p-3 bg-gray-900 border-b border-gray-800 shrink-0">
                            <StatCard title="Projected" value={`$${stats.monthlyProjected.toLocaleString()}`} icon={TrendingUp} colorClass="bg-blue-500 text-blue-500" />
                            <StatCard title="Earned" value={`$${stats.monthlyEarned.toLocaleString()}`} icon={CreditCard} colorClass="bg-emerald-500 text-emerald-500" />
                            <StatCard title="Pending" value={`$${stats.pendingPayment.toLocaleString()}`} icon={Clock} colorClass="bg-yellow-500 text-yellow-500" />
                        </div>
                    )}

                    {/* Main Content Area */}
                    <main className="flex-1 overflow-hidden relative">
                        {viewMode === 'board' ? (
                            <div className="h-full overflow-auto no-scrollbar p-2">
                                <div className="flex space-x-3 min-w-max pb-10 items-start h-full">
                                    {columns.map(col => (
                                        <div key={col.id} className="w-[300px] shrink-0 flex flex-col h-full">
                                            <div className="flex items-center mb-2 px-1 py-1 sticky top-0 bg-gray-950 z-20 border-b border-gray-800/50">
                                                <col.icon size={14} className={`mr-2 ${col.color}`} />
                                                <h3 className="font-semibold text-gray-300 text-xs">{col.label}</h3>
                                                <span className="ml-auto bg-gray-800 text-gray-500 text-[10px] px-2 py-0.5 rounded-full border border-gray-700">{projectsByStatus[col.id]?.length || 0}</span>
                                            </div>
                                            <div className="bg-gray-900/30 rounded-xl p-2 border border-gray-800/50 flex-1 min-h-0 overflow-y-auto custom-scrollbar touch-pan-y">
                                                <div className="space-y-2 pb-4">
                                                    {projectsByStatus[col.id]?.map(p => (
                                                        <ProjectCard key={p.id} project={p} onEdit={() => {setEditingProject(p); setIsModalOpen(true);}} onViewDetails={() => setViewingProject(p)} moveStatus={handleMoveStatus} />
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="h-full p-2">
                                <CalendarView 
                                    projects={data.projects} 
                                    currentDate={currentDate} 
                                    onEdit={(p) => {setEditingProject(p); setIsModalOpen(true);}} 
                                />
                            </div>
                        )}
                    </main>

                    {/* Modals & Components */}
                    <ProjectModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleSaveProject} onDelete={handleDeleteProject} initialData={editingProject} clients={data.clients} projects={data.projectList} />
                    <ListManager isOpen={isListManagerOpen} onClose={() => setIsListManagerOpen(false)} onUpdateLists={handleUpdateLists} initialClients={data.clients} initialProjects={data.projectList} allData={data} onImport={handleImportData} />
                    {viewingProject && <ProjectDetails project={viewingProject} onClose={() => setViewingProject(null)} onUpdate={handleUpdateNotes} onEdit={() => {setViewingProject(null); setEditingProject(viewingProject); setIsModalOpen(true);}} />}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>